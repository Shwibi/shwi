(this["webpackJsonpunacademy-live"]=this["webpackJsonpunacademy-live"]||[]).push([[1],{"28oz":function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("EVdn"),r=n("0JNz"),o=n("wCkA");s.sessions={},s.attach=null,s.windowClosing=!1,s.debug=e=>{},s.log=e=>{},s.attachMediaStream=(e,t)=>{},s.attach=e=>{},s.webRTCAdapter=null,s.error=(e,t)=>{};var a=window.RTCPeerConnection;function s(e,t=!0){if(void 0===s.initDone)return e.error("Library not initialized"),{};if(!s.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(s.log("Library initialized: "+s.initDone),(e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:s.noop,null===e.server||void 0===e.server)return e.error("Invalid gateway url"),{};var n=!1,i=null,r={},o=null,a=null,d=0,c=e.server;s.isArray(c)?(s.log("Multiple servers provided ("+c.length+"), will use the first that works"),c=null,a=e.server,s.debug(a)):0===c.indexOf("ws")?(n=!0,s.log("Using WebSockets to contact Janus: "+c)):(n=!1,s.log("Using REST API to contact Janus: "+c));var l=e.iceServers;void 0!==l&&null!==l||(l=[{urls:"stun:stun.l.google.com:19302"}]);var u=e.iceTransportPolicy,h=e.bundlePolicy,v=e.ipv6;void 0!==v&&null!==v||(v=!1);var f=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(f=!0===e.withCredentials);var g=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(g=e.max_poll_events),g<1&&(g=1);var p="";void 0!==e.token&&null!==e.token&&(p=e.token);var m=null;void 0!==e.apisecret&&null!==e.apisecret&&(m=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var b=!1,S=null,k={},C=this,y=0,w={};function T(){if(null!=S)if(s.debug("Long poll..."),b){var t=c+"/"+S+"?rid="+(new Date).getTime();void 0!==g&&null!==g&&(t=t+"&maxev="+g),null!==p&&void 0!==p&&(t=t+"&token="+p),null!==m&&void 0!==m&&(t=t+"&apisecret="+m),s.httpAPICall(t,{verb:"GET",withCredentials:f,success:E,timeout:6e4,error:function(t,n){if(s.error(t+": "+n),++y>3)return b=!1,void e.error("Lost connection to the gateway (is it down?)");T()}})}else s.warn("Is the gateway down? (connected=false)")}function E(e,t){if(y=0,n||void 0===S||null===S||!0===t||setTimeout(T,200),n||!s.isArray(e))if("keepalive"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");if(void 0===(l=k[d])||null===l)return void s.debug("This handle is not attached to this session");var i=e.candidate;s.debug("Got a trickled candidate on session "+S),s.debug(i);var r=l.webrtcStuff;r.pc&&r.remoteSdp?(s.debug("Adding remote candidate:",i),i&&!0!==i.completed?r.pc.addIceCandidate(new RTCIceCandidate(i)):r.pc.addIceCandidate()):(s.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),r.candidates||(r.candidates=[]),r.candidates.push(i),s.debug(r.candidates))}else{if("webrtcup"===e.janus)return s.debug("Got a webrtcup event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d?void s.warn("Missing sender..."):void 0===(l=k[d])||null===l?void s.debug("This handle is not attached to this session"):void l.webrtcState(!0);if("hangup"===e.janus){if(s.debug("Got a hangup event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");if(void 0===(l=k[d])||null===l)return void s.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.janus){if(s.debug("Got a detached event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");if(void 0===(l=k[d])||null===l)return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.janus){if(s.debug("Got a media event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");if(void 0===(l=k[d])||null===l)return void s.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(s.debug("Got a slowlink event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");if(void 0===(l=k[d])||null===l)return void s.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.nacks)}else{if("error"===e.janus){var o,a;if(s.error("Ooops: "+e.error.code+" "+e.error.reason),s.debug(e),null!==(o=e.transaction)&&void 0!==o)null!==(a=w[o])&&void 0!==a&&a(e),delete w[o];return}if("event"===e.janus){var d;if(s.debug("Got a plugin event on session "+S),s.debug(e),void 0===(d=e.sender)||null===d)return void s.warn("Missing sender...");var c=e.plugindata;if(void 0===c||null===c)return void s.warn("Missing plugindata...");s.debug("  -- Event is coming from "+d+" ("+c.plugin+")");var l,u=c.data;if(s.debug(u),void 0===(l=k[d])||null===l)return void s.warn("This handle is not attached to this session");var h=e.jsep;void 0!==h&&null!==h&&(s.debug("Handling SDP as well..."),s.debug(h));var v=l.onmessage;null!==v&&void 0!==v?(s.debug("Notifying application..."),v(u,h)):s.debug("No provided notification callback")}else s.warn("Unknown message/event  '"+e.janus+"' on session "+S),s.debug(e)}}else s.debug("Got a success on session "+S),s.debug(e),null!==(o=e.transaction)&&void 0!==o&&(null!==(a=w[o])&&void 0!==a&&a(e),delete w[o]);else s.debug("Got an ack on session "+S),s.debug(e),null!==(o=e.transaction)&&void 0!==o&&(null!==(a=w[o])&&void 0!==a&&a(e),delete w[o]);else s.vdebug("Got a keepalive on session "+S);else for(var f=0;f<e.length;f++)E(e[f],!0)}function D(){if(null!==c&&n&&b){o=setTimeout(D,1e3*window.keepAliveTime);var e={janus:"keepalive",session_id:S,transaction:s.randomString(12)};null!==p&&void 0!==p&&(e.token=p),null!==m&&void 0!==m&&(e.apisecret=m),1==i.readyState&&i.send(JSON.stringify(e))}}function I(t,l){var u=s.randomString(12),h={janus:"create",transaction:u};if(t.reconnect&&(b=!1,h.janus="claim",h.session_id=S,i&&(i.onopen=null,i.onerror=null,i.onclose=null,o&&(clearTimeout(o),o=null))),null!==p&&void 0!==p&&(h.token=p),null!==m&&void 0!==m&&(h.apisecret=m),null===c&&s.isArray(a)&&(0===(c=a[d]).indexOf("ws")?(n=!0,s.log("Server #"+(d+1)+": trying WebSockets to contact Janus ("+c+")")):(n=!1,s.log("Server #"+(d+1)+": trying REST API to contact Janus ("+c+")"))),n)for(var v in i=s.newWebSocket(c,"janus-protocol"),r={error:function(){if(s.error("Error connecting to the Janus WebSockets server... "+c),s.isArray(a))return++d==a.length?void t.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(c=null,void setTimeout((function(){I(t)}),200));t.error("Error connecting to the Janus WebSockets server: Is the gateway down?")},open:function(){w[u]=function(e){if(s.debug(e),"success"!==e.janus)return s.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);o=setTimeout(D,1e3*window.keepAliveTime),b=!0,S=e.session_id?e.session_id:e.data.id,s.log("Created session: "+S),s.sessions[S]=C,t.success()},i.send(JSON.stringify(h))},message:function(e){E(JSON.parse(e.data))},close:function(t){t.wasClean||(window.keepAliveTime=3),null!==c&&b&&(b=!1,e.error("Lost connection to the gateway (is it down?)"))}})i.addEventListener(v,r[v]);else s.httpAPICall(c,{verb:"POST",withCredentials:f,body:h,success:function(e){if(s.debug(e),"success"!==e.janus)return s.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);b=!0,S=e.session_id?e.session_id:e.data.id,t.reconnect?s.log("Claimed session: "+S):s.log("Created session: "+S),s.sessions[S]=C,l&&T(),t.success()},error:function(e,n){if(s.error(e+": "+n),s.isArray(a))return++d==a.length?void t.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(c=null,void setTimeout((function(){I(t,l)}),200));""===n?t.error(e+": Is the gateway down?"):t.error(e+": "+n)}})}function A(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:s.noop,!b)return s.warn("Is the gateway down? (connected=false)"),void t.error("Is the gateway down? (connected=false)");var r=t.message,o=t.jsep,a=s.randomString(12),d={janus:"message",body:r,transaction:a};if(null!==p&&void 0!==p&&(d.token=p),null!==m&&void 0!==m&&(d.apisecret=m),null!==o&&void 0!==o&&(d.jsep=o),s.debug("Sending message to plugin (handle="+e+"):"),s.debug(d),n){d.session_id=S,d.handle_id=e,w[a]=function(e){if(s.debug("Message sent!"),s.debug(e),"success"===e.janus){var n=e.plugindata;if(void 0===n||null===n)return s.warn("Request succeeded, but missing plugindata..."),void t.success();s.log("Synchronous transaction successful ("+n.plugin+")");var i=n.data;return s.debug(i),void t.success(i)}"ack"===e.janus?t.success():void 0!==e.error&&null!==e.error?(s.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(s.error("Unknown error"),t.error("Unknown error"))};try{1===i.readyState?i.send(JSON.stringify(d)):t.error&&t.error()}catch(l){t.error&&t.error(l)}}else s.httpAPICall(c+"/"+S+"/"+e,{verb:"POST",withCredentials:f,body:d,success:function(e){if(s.debug("Message sent!"),s.debug(e),"success"===e.janus){var n=e.plugindata;if(void 0===n||null===n)return s.warn("Request succeeded, but missing plugindata..."),void t.success();s.log("Synchronous transaction successful ("+n.plugin+")");var i=n.data;return s.debug(i),void t.success(i)}"ack"===e.janus?t.success():void 0!==e.error&&null!==e.error?(s.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(s.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){s.error(e+": "+n),t.error(e+": "+n)}})}function R(e,t){if(b){var r={janus:"trickle",candidate:t,transaction:s.randomString(12)};if(null!==p&&void 0!==p&&(r.token=p),null!==m&&void 0!==m&&(r.apisecret=m),s.vdebug("Sending trickle candidate (handle="+e+"):"),s.vdebug(r),n)return r.session_id=S,r.handle_id=e,void i.send(JSON.stringify(r));s.httpAPICall(c+"/"+S+"/"+e,{verb:"POST",withCredentials:f,body:r,success:function(e){s.vdebug("Candidate sent!"),s.vdebug(e),"ack"===e.janus||s.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){s.error(e+": "+t)}})}else s.warn("Is the gateway down? (connected=false)")}function O(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:s.noop;var n=k[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return s.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff,r=t.text;if(null===r||void 0===r)return s.warn("Invalid text"),void t.error("Invalid text");s.log("Sending string on data channel: "+r),i.dataChannel.send(r),t.success()}function N(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:s.noop;var n=k[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return s.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff;if(null===i.dtmfSender||void 0===i.dtmfSender){if(void 0!==i.pc&&null!==i.pc){var r=i.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!r)return s.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");i.dtmfSender=r.dtmf,i.dtmfSender&&(s.log("Created DTMF Sender"),i.dtmfSender.ontonechange=function(e){s.debug("Sent DTMF tone: "+e.tone)})}if(null===i.dtmfSender||void 0===i.dtmfSender)return s.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var o=t.dtmf;if(null===o||void 0===o)return s.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var a=o.tones;if(null===a||void 0===a)return s.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var d=o.duration;null!==d&&void 0!==d||(d=500);var c=o.gap;null!==c&&void 0!==c||(c=50),s.debug("Sending DTMF string "+a+" (duration "+d+"ms, gap "+c+"ms)"),i.dtmfSender.insertDTMF(a,d,c)}function L(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:s.noop;var r=!0;if(void 0!==t.asyncRequest&&null!==t.asyncRequest&&(r=!0===t.asyncRequest),s.log("Destroying handle "+e+" (async="+r+")"),H(e),k[e].detached)return delete k[e],void t.success();if(!b)return s.warn("Is the gateway down? (connected=false)"),void t.error("Is the gateway down? (connected=false)");var o={janus:"detach",transaction:s.randomString(12)};if(null!==p&&void 0!==p&&(o.token=p),null!==m&&void 0!==m&&(o.apisecret=m),n){o.session_id=S,o.handle_id=e;try{1===i.readyState&&i.send(JSON.stringify(o))}catch(a){console.log(a)}return delete k[e],void t.success()}s.httpAPICall(c+"/"+S+"/"+e,{verb:"POST",async:r,withCredentials:f,body:o,success:function(n){s.log("Destroyed handle:"),s.debug(n),"success"!==n.janus&&s.error("Ooops: "+n.error.code+" "+n.error.reason),delete k[e],t.success()},error:function(n,i){s.error(n+": "+i),delete k[e],t.success()}})}function _(e,t,n,i,r){var o=k[e];if(null===o||void 0===o||null===o.webrtcStuff||void 0===o.webrtcStuff)return s.warn("Invalid handle"),void i.error("Invalid handle");var a=o.webrtcStuff;s.debug("streamsDone:",r),r&&(s.debug("  -- Audio tracks:",r.getAudioTracks()),s.debug("  -- Video tracks:",r.getVideoTracks()));var d=!1;if(a.myStream&&n.update&&!a.streamExternal){if((!n.update&&J(n)||n.update&&(n.addAudio||n.replaceAudio))&&r.getAudioTracks()&&r.getAudioTracks().length)if(a.myStream.addTrack(r.getAudioTracks()[0]),n.replaceAudio&&"firefox"===s.webRTCAdapter.browserDetails.browser)for(var c in s.log("Replacing audio track:",r.getAudioTracks()[0]),a.pc.getSenders()){(p=a.pc.getSenders()[c])&&p.track&&"audio"===p.track.kind&&p.replaceTrack(r.getAudioTracks()[0])}else if("firefox"===s.webRTCAdapter.browserDetails.browser&&s.webRTCAdapter.browserDetails.version>=59){s.log((n.replaceVideo?"Replacing":"Adding")+" video track:",r.getVideoTracks()[0]);var f=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var g in m){if((S=m[g]).sender&&S.sender.track&&"audio"===S.sender.track.kind||S.receiver&&S.receiver.track&&"audio"===S.receiver.track.kind){f=S;break}}f&&f.sender?f.sender.replaceTrack(r.getVideoTracks()[0]):a.pc.addTrack(r.getVideoTracks()[0],r)}else s.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",r.getAudioTracks()[0]),a.pc.addTrack(r.getAudioTracks()[0],r);if((!n.update&&B(n)||n.update&&(n.addVideo||n.replaceVideo))&&r.getVideoTracks()&&r.getVideoTracks().length)if(a.myStream.addTrack(r.getVideoTracks()[0]),n.replaceVideo&&"firefox"===s.webRTCAdapter.browserDetails.browser)for(var c in s.log("Replacing video track:",r.getVideoTracks()[0]),a.pc.getSenders()){var p;(p=a.pc.getSenders()[c])&&p.track&&"video"===p.track.kind&&p.replaceTrack(r.getVideoTracks()[0])}else if("firefox"===s.webRTCAdapter.browserDetails.browser&&s.webRTCAdapter.browserDetails.version>=59){s.log((n.replaceVideo?"Replacing":"Adding")+" video track:",r.getVideoTracks()[0]);var m,b=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var g in m){var S;if((S=m[g]).sender&&S.sender.track&&"video"===S.sender.track.kind||S.receiver&&S.receiver.track&&"video"===S.receiver.track.kind){b=S;break}}b&&b.sender?b.sender.replaceTrack(r.getVideoTracks()[0]):a.pc.addTrack(r.getVideoTracks()[0],r)}else s.log((n.replaceVideo?"Replacing":"Adding")+" video track:",r.getVideoTracks()[0]),a.pc.addTrack(r.getVideoTracks()[0],r)}else a.myStream=r,d=!0;if(!a.pc){var C={iceServers:l,iceTransportPolicy:u,bundlePolicy:h},y={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===v&&y.optional.push({googIPv6:!0}),i.rtcConstraints&&"object"===typeof i.rtcConstraints)for(var g in s.debug("Adding custom PeerConnection constraints:",i.rtcConstraints),i.rtcConstraints)y.optional.push(i.rtcConstraints[g]);"edge"===s.webRTCAdapter.browserDetails.browser&&(C.bundlePolicy="max-bundle"),s.log("Creating PeerConnection"),s.debug(y),a.pc=new RTCPeerConnection(C,y),s.debug(a.pc),a.pc.getStats&&(a.volume.value=0,a.bitrate.value="0 kbits/sec"),s.log("Preparing local SDP and gathering candidates (trickle="+a.trickle+")"),a.pc.oniceconnectionstatechange=function(e){a.pc&&o.iceState(a.pc.iceConnectionState)},a.pc.onicecandidate=function(t){if(null==t.candidate||"edge"===s.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)s.log("End of candidates."),a.iceDone=!0,!0===a.trickle?R(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:s.noop;var n=k[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return void s.warn("Invalid handle, not sending anything");var i=n.webrtcStuff;if(s.log("Sending offer/answer SDP..."),null===i.mySdp||void 0===i.mySdp)return void s.warn("Local SDP instance is invalid, not sending anything...");i.mySdp={type:i.pc.localDescription.type,sdp:i.pc.localDescription.sdp},!1===i.trickle&&(i.mySdp.trickle=!1);s.debug(t),i.sdpSent=!0,t.success(i.mySdp)}(e,i);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===a.trickle&&R(e,n)}},a.pc.ontrack=function(e){s.log("Handling Remote Track"),s.debug(e),e.streams&&(a.remoteStream=e.streams[0],o.onremotestream(a.remoteStream),e.track&&!e.track.onended&&(s.log("Adding onended callback to track:",e.track),e.track.onended=function(e){s.log("Remote track removed:",e),a.remoteStream&&(a.remoteStream.removeTrack(e.target),o.onremotestream(a.remoteStream))}))}}if(d&&null!==r&&void 0!==r&&(s.log("Adding local stream"),r.getTracks().forEach((function(e){a.pc.addTrack(e,r)}))),function(e){if(s.debug("isDataEnabled:",e),"edge"==s.webRTCAdapter.browserDetails.browser)return s.warn("Edge doesn't support data channels yet"),!1;return void 0!==e&&null!==e&&!0===e.data}(n)&&!a.dataChannel){s.log("Creating data channel");var w=function(){var e=null!==a.dataChannel?a.dataChannel.readyState:"null";s.log("State change on data channel: "+e),"open"===e&&o.ondataopen(),o.onDataChannelStateChange&&o.onDataChannelStateChange(e)};a.dataChannel=a.pc.createDataChannel("JanusDataChannel",{ordered:!0}),a.dataChannel.onmessage=function(e){s.log("Received message on data channel: "+e.data),o.ondata(e.data)},a.dataChannel.onopen=w,a.dataChannel.onclose=w,a.dataChannel.onerror=function(e){s.error("Got error on data channel:",e)}}a.myStream&&o.onlocalstream(a.myStream),null===t||void 0===t?function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:s.noop,n.error="function"==typeof n.error?n.error:s.noop;var i=k[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return s.warn("Invalid handle"),void n.error("Invalid handle");var r=i.webrtcStuff,o=!0===n.simulcast;o?s.log("Creating offer (iceDone="+r.iceDone+", simulcast="+o+")"):s.log("Creating offer (iceDone="+r.iceDone+")");var a={offerToReceiveAudio:q(t),offerToReceiveVideo:W(t)};!0===n.iceRestart&&(a.iceRestart=!0);s.debug(a);var d=B(t);if(d&&o&&"firefox"===s.webRTCAdapter.browserDetails.browser){s.log("Enabling Simulcasting for Firefox (RID)");var c=r.pc.getSenders()[1];s.log(c);var l=c.getParameters();s.log(l),c.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}r.pc.createOffer((function(e){if(s.debug(e),s.log("Setting local description"),d&&o&&("chrome"===s.webRTCAdapter.browserDetails.browser?(s.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),n=!1,i=[-1],r=-1,o=null,a=null,d=null,c=null,l=-1,u=0;u<t.length;u++){if(v=t[u].match(/m=(\w+) */)){if("video"===v[1]){if(!(i[0]<0)){l=u;break}n=!0}else if(i[0]>-1){l=u;break}}else if(n){var h=t[u].match(/a=ssrc-group:FID (\d+) (\d+)/);if(h)i[0]=h[1],r=h[2],t.splice(u,1),u--;else{if(i[0]){if((g=t[u].match("a=ssrc:"+i[0]+" cname:(.+)"))&&(o=g[1]),(g=t[u].match("a=ssrc:"+i[0]+" msid:(.+)"))&&(a=g[1]),(g=t[u].match("a=ssrc:"+i[0]+" mslabel:(.+)"))&&(d=g[1]),(g=t[u].match("a=ssrc:"+i+" label:(.+)"))&&(c=g[1]),0===t[u].indexOf("a=ssrc:"+r)){t.splice(u,1),u--;continue}if(0===t[u].indexOf("a=ssrc:"+i[0])){t.splice(u,1),u--;continue}}0!=t[u].length||(t.splice(u,1),u--)}}}if(i[0]<0){l=-1,n=!1;for(u=0;u<t.length;u++){var v;if(v=t[u].match(/m=(\w+) */)){if("video"===v[1]){if(!(i[0]<0)){l=u;break}n=!0}else if(i[0]>-1){l=u;break}}else if(n){if(i[0]<0){var f=t[u].match(/a=ssrc:(\d+)/);if(f){i[0]=f[1],t.splice(u,1),u--;continue}}else{var g;if((g=t[u].match("a=ssrc:"+i[0]+" cname:(.+)"))&&(o=g[1]),(g=t[u].match("a=ssrc:"+i[0]+" msid:(.+)"))&&(a=g[1]),(g=t[u].match("a=ssrc:"+i[0]+" mslabel:(.+)"))&&(d=g[1]),(g=t[u].match("a=ssrc:"+i[0]+" label:(.+)"))&&(c=g[1]),0===t[u].indexOf("a=ssrc:"+r)){t.splice(u,1),u--;continue}if(0===t[u].indexOf("a=ssrc:"+i[0])){t.splice(u,1),u--;continue}}0!=t[u].length||(t.splice(u,1),u--)}}}if(i[0]<0)return s.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;l<0&&(l=t.length);i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random()),r[1]=Math.floor(4294967295*Math.random()),r[2]=Math.floor(4294967295*Math.random());for(u=0;u<i.length;u++)o&&(t.splice(l,0,"a=ssrc:"+i[u]+" cname:"+o),l++),a&&(t.splice(l,0,"a=ssrc:"+i[u]+" msid:"+a),l++),d&&(t.splice(l,0,"a=ssrc:"+i[u]+" mslabel:"+d),l++),c&&(t.splice(l,0,"a=ssrc:"+i[u]+" label:"+c),l++),o&&(t.splice(l,0,"a=ssrc:"+r[u]+" cname:"+o),l++),a&&(t.splice(l,0,"a=ssrc:"+r[u]+" msid:"+a),l++),d&&(t.splice(l,0,"a=ssrc:"+r[u]+" mslabel:"+d),l++),c&&(t.splice(l,0,"a=ssrc:"+r[u]+" label:"+c),l++);t.splice(l,0,"a=ssrc-group:FID "+i[2]+" "+r[2]),t.splice(l,0,"a=ssrc-group:FID "+i[1]+" "+r[1]),t.splice(l,0,"a=ssrc-group:FID "+i[0]+" "+r[0]),t.splice(l,0,"a=ssrc-group:SIM "+i[0]+" "+i[1]+" "+i[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==s.webRTCAdapter.browserDetails.browser&&s.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),r.mySdp=e.sdp,r.pc.setLocalDescription(e),r.mediaConstraints=a,r.iceDone||r.trickle){s.log("Offer ready"),s.debug(n);var t={type:e.type,sdp:e.sdp};n.success(t)}else s.log("Waiting for all candidates...")}),n.error,a)}(e,n,i):a.pc.setRemoteDescription(new RTCSessionDescription(t),(function(){s.log("Remote description accepted!"),function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:s.noop,n.error="function"==typeof n.error?n.error:s.noop;var i=k[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return s.warn("Invalid handle"),void n.error("Invalid handle");var r=i.webrtcStuff,o=!0===n.simulcast;o?s.log("Creating answer (iceDone="+r.iceDone+", simulcast="+o+")"):s.log("Creating answer (iceDone="+r.iceDone+")");var a=null;a="firefox"==s.webRTCAdapter.browserDetails.browser||"edge"==s.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:q(t),offerToReceiveVideo:W(t)}:{mandatory:{OfferToReceiveAudio:q(t),OfferToReceiveVideo:W(t)}};s.debug(a);var d=B(t);if(d&&o&&"firefox"===s.webRTCAdapter.browserDetails.browser){s.log("Enabling Simulcasting for Firefox (RID)");var c=r.pc.getSenders()[1];s.log(c);var l=c.getParameters();s.log(l),c.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}r.pc.createAnswer((function(e){if(s.debug(e),s.log("Setting local description"),d&&o&&("chrome"===s.webRTCAdapter.browserDetails.browser?s.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==s.webRTCAdapter.browserDetails.browser&&s.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),r.mySdp=e.sdp,r.pc.setLocalDescription(e),r.mediaConstraints=a,r.iceDone||r.trickle){var t={type:e.type,sdp:e.sdp};n.success(t)}else s.log("Waiting for all candidates...")}),n.error,a)}(e,n,i)}),i.error)}function P(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:x;var n=t.jsep;t.media=t.media||{audio:!0,video:!0};var i=t.media,r=k[e];if(null===r||void 0===r||null===r.webrtcStuff||void 0===r.webrtcStuff)return s.warn("Invalid handle"),void t.error("Invalid handle");var o,a=r.webrtcStuff;if(a.trickle=(o=t.trickle,s.debug("isTrickleEnabled:",o),void 0===o||null===o||!0===o),void 0===a.pc||null===a.pc)i.update=!1;else if(void 0!==a.pc&&null!==a.pc)if(s.log("Updating existing media session"),i.update=!0,null!==t.stream&&void 0!==t.stream)t.stream!==a.myStream&&s.log("Renegotiation involves a new external stream");else{if(i.addAudio){if(i.replaceAudio=!1,i.removeAudio=!1,i.audioSend=!0,a.myStream&&a.myStream.getAudioTracks()&&a.myStream.getAudioTracks().length)return s.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else i.removeAudio?(i.replaceAudio=!1,i.addAudio=!1,i.audioSend=!1):i.replaceAudio&&(i.addAudio=!1,i.removeAudio=!1,i.audioSend=!0);if(null===a.myStream||void 0===a.myStream?(i.replaceAudio&&(i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),J(i)&&(i.addAudio=!0)):null!==a.myStream.getAudioTracks()&&void 0!==a.myStream.getAudioTracks()&&0!==a.myStream.getAudioTracks().length||(i.replaceAudio&&(i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),J(i)&&(i.addAudio=!0)),i.addVideo){if(i.replaceVideo=!1,i.removeVideo=!1,i.videoSend=!0,a.myStream&&a.myStream.getVideoTracks()&&a.myStream.getVideoTracks().length)return s.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else i.removeVideo?(i.replaceVideo=!1,i.addVideo=!1,i.videoSend=!1):i.replaceVideo&&(i.addVideo=!1,i.removeVideo=!1,i.videoSend=!0);null===a.myStream||void 0===a.myStream?(i.replaceVideo&&(i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),B(i)&&(i.addVideo=!0)):null!==a.myStream.getVideoTracks()&&void 0!==a.myStream.getVideoTracks()&&0!==a.myStream.getVideoTracks().length||(i.replaceVideo&&(i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),B(i)&&(i.addVideo=!0)),i.addData&&(i.data=!0)}if(i.update&&!a.streamExternal){if(i.removeAudio||i.replaceAudio){if(a.myStream&&a.myStream.getAudioTracks()&&a.myStream.getAudioTracks().length){var d=a.myStream.getAudioTracks()[0];s.log("Removing audio track:",d),a.myStream.removeTrack(d);try{d.stop()}catch(N){}}if(a.pc.getSenders()&&a.pc.getSenders().length){var c=!0;if(i.replaceAudio&&"firefox"===s.webRTCAdapter.browserDetails.browser&&(c=!1),c)for(var l in a.pc.getSenders()){(d=a.pc.getSenders()[l])&&d.track&&"audio"===d.track.kind&&(s.log("Removing audio sender:",d),a.pc.removeTrack(d))}}}if(i.removeVideo||i.replaceVideo){if(a.myStream&&a.myStream.getVideoTracks()&&a.myStream.getVideoTracks().length){d=a.myStream.getVideoTracks()[0];s.log("Removing video track:",d),a.myStream.removeTrack(d);try{d.stop()}catch(N){}}if(a.pc.getSenders()&&a.pc.getSenders().length){var u=!0;if(i.replaceVideo&&"firefox"===s.webRTCAdapter.browserDetails.browser&&(u=!1),u)for(var l in a.pc.getSenders()){(d=a.pc.getSenders()[l])&&d.track&&"video"===d.track.kind&&(s.log("Removing video sender:",d),a.pc.removeTrack(d))}}}}if(null!==t.stream&&void 0!==t.stream){var h=t.stream;if(s.log("MediaStream provided by the application"),s.debug(h),i.update&&a.myStream&&a.myStream!==t.stream&&!a.streamExternal){try{var v=a.myStream.getTracks();for(var f in v){var g=v[f];s.log(g),null!==g&&void 0!==g&&g.stop()}}catch(N){}a.myStream=null}return a.streamExternal=!0,void _(e,n,i,t,h)}if(J(i)||B(i)){var p={mandatory:{},optional:[]};r.consentDialog(!0);var m=J(i);!0===m&&void 0!=i&&null!=i&&"object"===typeof i.audio&&(m=i.audio);var b=B(i);if(!0===b&&void 0!=i&&null!=i)if(!(!0===t.simulcast)||n||void 0!==i.video&&!1!==i.video||(i.video="hires"),i.video&&"screen"!=i.video&&"window"!=i.video){var S=0,C=0,y=0;if("lowres"===i.video)C=240,y=240,S=320;else if("lowres-16:9"===i.video)C=180,y=180,S=320;else if("hires"===i.video||"hires-16:9"===i.video){if(C=720,y=720,S=1280,navigator.mozGetUserMedia)(w=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10))<38&&(s.warn(i.video+" unsupported, falling back to stdres (old Firefox)"),C=720,y=720,S=1280)}else"stdres"===i.video||"stdres-16:9"===i.video?(C=720,y=720,S=1280):(s.log("Default video setting is stdres 4:3"),C=720,y=720,S=1280);if(s.log("Adding media constraint:",i.video),navigator.mozGetUserMedia){var w=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10);b=w<38?{require:["height","width"],height:{max:y,min:C},width:{max:S,min:S}}:{height:{ideal:C},width:{ideal:S}}}else b={mandatory:{maxHeight:y,minHeight:C,maxWidth:S,minWidth:S},optional:[]};"object"===typeof i.video&&(b=i.video),s.debug(b)}else if("screen"===i.video||"window"===i.video){i.screenshareFrameRate||(i.screenshareFrameRate=3);var T={};function E(o,a){r.consentDialog(!1),o?t.error({code:o.code,name:o.name,message:o.message}):_(e,n,i,t,a)}function D(e,t,n){s.log("Adding media constraint (screen capture)"),s.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)})):t(null,e)})).catch((function(e){r.consentDialog(!1),t(e)}))}if("chrome"===s.webRTCAdapter.browserDetails.browser){var I=s.webRTCAdapter.browserDetails.version,A=33;if(window.navigator.userAgent.match("Linux")&&(A=35),I>=26&&I<=A)D(p={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate,chromeMediaSource:"screen"}},audio:J(i)},E);else{var R=window.setTimeout((function(){return(O=new Error("NavigatorUserMediaError")).name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',r.consentDialog(!1),t.error(O)}),1e3);T[R]=[E,null],window.postMessage({type:"janusGetScreen",id:R},"*")}}else if(window.navigator.userAgent.match("Firefox")){if(!(parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10)>=33)){var O=new Error("NavigatorUserMediaError");return O.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",r.consentDialog(!1),void t.error(O)}D(p={video:{mozMediaSource:i.video,mediaSource:i.video},audio:J(i)},(function(e,t){if(E(e,t),!e)var n=t.currentTime,i=window.setInterval((function(){t||window.clearInterval(i),t.currentTime==n&&(window.clearInterval(i),t.onended&&t.onended()),n=t.currentTime}),500)}))}return void window.addEventListener("message",(function(e){if(e.origin==window.location.origin)if("janusGotScreen"==e.data.type&&T[e.data.id]){var n=T[e.data.id][0];if(delete T[e.data.id],""===e.data.sourceId){var o=new Error("NavigatorUserMediaError");o.name="You cancelled the request for permission, giving up...",r.consentDialog(!1),t.error(o)}else(p={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=e.data.sourceId,D(p,n,J(i))}else"janusGetScreenPending"==e.data.type&&window.clearTimeout(e.data.id)}))}null!==i&&void 0!==i&&"screen"===i.video||navigator.mediaDevices.enumerateDevices().then((function(o){var a=o.some((function(e){return"audioinput"===e.kind})),d=o.some((function(e){return"videoinput"===e.kind})),c=J(i),l=B(i),u=function(e){return s.debug("isAudioSendRequired:",e),void 0!==e&&null!==e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(i),h=function(e){return s.debug("isVideoSendRequired:",e),void 0!==e&&null!==e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(i);if(c||l||u||h){var v=!!c&&a,f=!!l&&d;if(!v&&!f)return r.consentDialog(!1),t.error("No capture device found"),!1;if(!v&&u)return r.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!f&&h)return r.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}navigator.mediaDevices.getUserMedia({audio:!!a&&m,video:!!d&&b}).then((function(o){r.consentDialog(!1),_(e,n,i,t,o)})).catch((function(e){console.log("Get user media janus error",e),r.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})}))})).catch((function(e){r.consentDialog(!1),t.error("enumerateDevices error",e),console.log("Janus get devices fail",e)}))}else _(e,n,i,t)}function F(e,t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop,t.error="function"==typeof t.error?t.error:x;var n=t.jsep,i=k[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return s.warn("Invalid handle"),void t.error("Invalid handle");var r=i.webrtcStuff;if(void 0!==n&&null!==n){if(null===r.pc)return s.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");r.pc.setRemoteDescription(new RTCSessionDescription(n),(function(){if(s.log("Remote description accepted!"),r.remoteSdp=n.sdp,r.candidates&&r.candidates.length>0){for(var e in r.candidates){var t=r.candidates[e];s.debug("Adding remote candidate:",t),t&&!0!==t.completed?r.pc.addIceCandidate(new RTCIceCandidate(t)):r.pc.addIceCandidate()}r.candidates=[]}}),t.error)}else t.error("Invalid JSEP")}function M(e){var t=k[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return s.warn("Invalid handle"),0;var n=t.webrtcStuff;return n.pc.getStats&&"chrome"==s.webRTCAdapter.browserDetails.browser?null===n.remoteStream||void 0===n.remoteStream?(s.warn("Remote stream unavailable"),0):null===n.volume.timer||void 0===n.volume.timer?(s.log("Starting volume monitor"),n.volume.timer=setInterval((function(){n.pc.getStats((function(e){for(var t=e.result(),i=0;i<t.length;i++){var r=t[i];"ssrc"==r.type&&r.stat("audioOutputLevel")&&(n.volume.value=r.stat("audioOutputLevel"))}}))}),200),0):n.volume.value:(s.log("Getting the remote volume unsupported by browser"),0)}function V(e,t){var n=k[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return s.warn("Invalid handle"),!0;var i=n.webrtcStuff;return null===i.pc||void 0===i.pc?(s.warn("Invalid PeerConnection"),!0):void 0===i.myStream||null===i.myStream?(s.warn("Invalid local MediaStream"),!0):t?null===i.myStream.getVideoTracks()||void 0===i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length?(s.warn("No video track"),!0):!i.myStream.getVideoTracks()[0].enabled:null===i.myStream.getAudioTracks()||void 0===i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length?(s.warn("No audio track"),!0):!i.myStream.getAudioTracks()[0].enabled}function U(e,t,n){var i=k[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return s.warn("Invalid handle"),!1;var r=i.webrtcStuff;return null===r.pc||void 0===r.pc?(s.warn("Invalid PeerConnection"),!1):void 0===r.myStream||null===r.myStream?(s.warn("Invalid local MediaStream"),!1):t?null===r.myStream.getVideoTracks()||void 0===r.myStream.getVideoTracks()||0===r.myStream.getVideoTracks().length?(s.warn("No video track"),!1):(r.myStream.getVideoTracks()[0].enabled=!n,!0):null===r.myStream.getAudioTracks()||void 0===r.myStream.getAudioTracks()||0===r.myStream.getAudioTracks().length?(s.warn("No audio track"),!1):(r.myStream.getAudioTracks()[0].enabled=!n,!0)}function j(e){var t=k[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return s.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?"Invalid PeerConnection":n.pc.getStats?null===n.bitrate.timer||void 0===n.bitrate.timer?(s.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval((function(){n.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var i=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"==s.webRTCAdapter.browserDetails.browser&&(i/=1e3);var r=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/i);n.bitrate.value=r+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):n.bitrate.value:(s.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function x(e){s.error("WebRTC error:",e)}function H(e,t){s.log("Cleaning WebRTC stuff");var r=k[e];if(null!==r&&void 0!==r){var o=r.webrtcStuff;if(null!==o&&void 0!==o){if(!0===t){var a={janus:"hangup",transaction:s.randomString(12)};null!==p&&void 0!==p&&(a.token=p),null!==m&&void 0!==m&&(a.apisecret=m),s.debug("Sending hangup request (handle="+e+"):"),s.debug(a),n?(a.session_id=S,a.handle_id=e,i.send(JSON.stringify(a))):s.httpAPICall(c+"/"+S+"/"+e,{verb:"POST",withCredentials:f,data:a})}o.remoteStream=null,o.volume.timer&&clearInterval(o.volume.timer),o.volume.value=null,o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null;try{if(!o.streamExternal&&null!==o.myStream&&void 0!==o.myStream){s.log("Stopping local stream tracks");var d=o.myStream.getTracks();for(var l in d){var u=d[l];s.log(u),null!==u&&void 0!==u&&u.stop()}}}catch(h){}o.streamExternal=!1,o.myStream=null;try{o.pc.close()}catch(h){}o.pc=null,o.candidates=null,o.mySdp=null,o.remoteSdp=null,o.iceDone=!1,o.dataChannel=null,o.dtmfSender=null}r.oncleanup()}}function J(e){return s.debug("isAudioSendEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function q(e){return s.debug("isAudioRecvEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function B(e){return s.debug("isVideoSendEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function W(e){return s.debug("isVideoRecvEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}I(e,t),this.getServer=function(){return c},this.isConnected=function(){return b},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.reconnect=!0,I(e)},this.getSessionId=function(){return S},this.destroy=function(t){!function(t){(t=t||{}).success="function"==typeof t.success?t.success:s.noop;var a=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(a=!0===t.asyncRequest);if(s.log("Destroying session "+S+" (async="+a+")"),!b)return s.warn("Is the gateway down? (connected=false)"),void t.success();if(void 0===S||null===S)return s.warn("No session to destroy"),t.success(),void e.destroyed();delete s.sessions[S];var d={janus:"destroy",transaction:s.randomString(12)};null!==p&&void 0!==p&&(d.token=p);null!==m&&void 0!==m&&(d.apisecret=m);if(n){d.session_id=S;var l=function(){for(var e in r)i.removeEventListener(e,r[e]);i.removeEventListener("message",u),i.removeEventListener("error",h),o&&clearTimeout(o),i.close()},u=function(n){var i=JSON.parse(n.data);i.session_id==d.session_id&&i.transaction==d.transaction&&(l(),t.success(),e.destroyed())},h=function(n){l(),t.error&&t.error("Failed to destroy the gateway: Is the gateway down?"),e.destroyed()};return i.addEventListener("message",u),i.addEventListener("error",h),void i.send(JSON.stringify(d))}let v=S;s.httpAPICall(c+"/"+S,{verb:"POST",async:a,withCredentials:f,body:d,success:function(n){s.log("Destroyed session:"),s.debug(n),v==S&&(S=null,b=!1),"success"!==n.janus&&s.error("Ooops: "+n.error.code+" "+n.error.reason),t.success(),e.destroyed()},error:function(n,i){s.error(n+": "+i),S=null,b=!1,t.success(),e.destroyed()}})}(t)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:s.noop,e.iceState="function"==typeof e.iceState?e.iceState:s.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:s.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:s.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:s.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:s.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:s.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:s.noop,e.ondata="function"==typeof e.ondata?e.ondata:s.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:s.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:s.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:s.noop,!b)return s.warn("Is the gateway down? (connected=false)"),void e.error("Is the gateway down? (connected=false)");var t=e.plugin;if(void 0===t||null===t)return s.error("Invalid plugin"),void e.error("Invalid plugin");var r=e.opaqueId,o=e.token?e.token:p,a=s.randomString(12),d={janus:"attach",plugin:t,opaque_id:r,transaction:a};null!==o&&void 0!==o&&(d.token=o);null!==m&&void 0!==m&&(d.apisecret=m);if(n)return w[a]=function(n){if(s.debug(n),"success"!==n.janus)return s.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var i=n.data.id;s.log("Created handle: "+i);var r={session:C,plugin:t,id:i,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return i},getPlugin:function(){return t},getVolume:function(){return M(i)},isAudioMuted:function(){return V(i,!1)},muteAudio:function(){return U(i,!1,!0)},unmuteAudio:function(){return U(i,!1,!1)},isVideoMuted:function(){return V(i,!0)},muteVideo:function(){return U(i,!0,!0)},unmuteVideo:function(){return U(i,!0,!1)},getBitrate:function(){return j(i)},send:function(e){A(i,e)},data:function(e){O(i,e)},dtmf:function(e){N(i,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){P(i,e)},createAnswer:function(e){P(i,e)},handleRemoteJsep:function(e){F(i,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,onDataChannelStateChange:e.onDataChannelStateChange,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(i,!0===e)},detach:function(e){L(i,e)}};k[i]=r,e.success(r)},d.session_id=S,void i.send(JSON.stringify(d));s.httpAPICall(c+"/"+S,{verb:"POST",withCredentials:f,body:d,success:function(n){if(s.debug(n),"success"!==n.janus)return s.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var i=n.data.id;s.log("Created handle: "+i);var r={session:C,plugin:t,id:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return i},getPlugin:function(){return t},getVolume:function(){return M(i)},isAudioMuted:function(){return V(i,!1)},muteAudio:function(){return U(i,!1,!0)},unmuteAudio:function(){return U(i,!1,!1)},isVideoMuted:function(){return V(i,!0)},muteVideo:function(){return U(i,!0,!0)},unmuteVideo:function(){return U(i,!0,!1)},getBitrate:function(){return j(i)},send:function(e){A(i,e)},data:function(e){O(i,e)},dtmf:function(e){N(i,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){P(i,e)},createAnswer:function(e){P(i,e)},handleRemoteJsep:function(e){F(i,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,onDataChannelStateChange:e.onDataChannelStateChange,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(i,!0===e)},detach:function(e){L(i,e)}};k[i]=r,e.success(r)},error:function(e,t){s.error(e+": "+t)}})}(e)}}window.RTCPeerConnection=function(e,t){const n={};if(Object.getOwnPropertyNames(e).forEach((function(t){n[t]=e[t]})),n&&n.iceServers){for(var i=0;i<n.iceServers.length;i++){var r=n.iceServers[i];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")&&(e.iceServers[i]=r)}return new a(n,t)}},s.extensionId="hapfgfdkleiggjjpfpenajgdnfckjpaj",s.isExtensionEnabled=function(){if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||s.checkJanusExtension()}return!0},s.destroyAllSessions=function(){for(var e in s.sessions)null!==s.sessions[e]&&void 0!==s.sessions[e]&&s.sessions[e].destroy()},s.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},s.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",i=0;i<e;i++){var r=Math.floor(Math.random()*t.length);n+=t.substring(r,r+1)}return n},s.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,n=e&&e.Promise||Promise,i=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},isArray:function(e){return Array.isArray(e)},checkJanusExtension:function(){return null!==document.querySelector("#janus-extension-installed")},webRTCAdapter:e&&e.adapter||r.a,httpAPICall:function(e,i){var r={method:i.verb,cache:"no-cache"};void 0!==i.withCredentials&&(r.credentials=!0===i.withCredentials?"include":i.withCredentials?i.withCredentials:"omit"),void 0!==i.body&&(r.body=JSON.stringify(i.body));var o=t(e,r).catch((function(e){return n.reject({message:"Probably a network error, is the gateway down?",error:e})}));if(void 0!==i.timeout){var a=new n((function(e,t){var n=setTimeout((function(){clearTimeout(n)}),i.timeout)}));o=n.race([o,a])}return o.then((function(e){return e.ok?typeof i.success===typeof s.noop?e.json().then((function(e){i.success(e)})).catch((function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:n.reject({message:"API call failed",response:e})})).catch((function(e){typeof i.error===typeof s.noop&&i.error(e.message||"<< internal error >>",e)})),o}}},s.useOldDependencies=function(e){var t=e&&e.jQuery||i.jQuery,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},isArray:function(e){return t.isArray(e)},checkJanusExtension:function(){return t("#janus-extension-installed").length>0},webRTCAdapter:e&&e.adapter||r.a,httpAPICall:function(e,n){var i=void 0!==n.body?{contentType:"application/json",data:JSON.stringify(n.body)}:{},r=void 0!==n.withCredentials?{xhrFields:{withCredentials:n.withCredentials}}:{};return t.ajax(t.extend(i,r,{url:e,type:n.verb,cache:!1,dataType:"json",async:n.async,timeout:n.timeout,success:function(e){typeof n.success===typeof s.noop&&n.success(e)},error:function(e,t,i){typeof n.error===typeof s.noop&&n.error(t,i)}}))}}},s.noop=function(){},s.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:s.noop,!0===s.initDone)e.callback();else{if("undefined"!=typeof console&&"undefined"!=typeof console.log||(console={log:function(){}}),s.trace=s.noop,s.debug=s.noop,s.vdebug=s.noop,s.log=s.noop,s.warn=s.noop,s.error=s.noop,!0===e.debug||"all"===e.debug)s.trace=console.trace.bind(console),s.debug=console.debug.bind(console),s.vdebug=console.debug.bind(console),s.log=console.log.bind(console),s.warn=console.warn.bind(console),s.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var t in e.debug){var n=e.debug[t];switch(n){case"trace":s.trace=console.trace.bind(console);break;case"debug":s.debug=console.debug.bind(console);break;case"vdebug":s.vdebug=console.debug.bind(console);break;case"log":s.log=console.log.bind(console);break;case"warn":s.warn=console.warn.bind(console);break;case"error":s.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}s.log("Initializing library");var i=e.dependencies||s.useDefaultDependencies();s.isArray=i.isArray,s.webRTCAdapter=i.webRTCAdapter,s.httpAPICall=i.httpAPICall,s.checkJanusExtension=i.checkJanusExtension,s.newWebSocket=i.newWebSocket,s.listDevices=function(e,t){e="function"==typeof e?e:s.noop,null==t&&(t={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(n){s.debug(n),e(n);try{var i=t.getTracks();for(var r in i){var o=i[r];null!==o&&void 0!==o&&o.stop()}}catch(a){console.log("Janus get devices fail",a)}}))})).catch((function(t){s.error(t),e([])})):(s.warn("navigator.mediaDevices unavailable"),e([]))},s.attachMediaStream=function(e,t){Object(o.h)(e,t)},s.reattachMediaStream=function(e,t){"chrome"===s.webRTCAdapter.browserDetails.browser?s.webRTCAdapter.browserDetails.version>=43?e.srcObject=t.srcObject:"undefined"!==typeof e.src?e.src=t.src:s.error("Error reattaching stream to element"):e.srcObject=t.srcObject};var r=window.onbeforeunload;window.onbeforeunload=function(){for(var e in s.windowClosing=!0,s.log("Closing window"),s.sessions)null!==s.sessions[e]&&void 0!==s.sessions[e]&&s.sessions[e].destroyOnUnload&&(s.log("Destroying session "+e),s.sessions[e].destroy({asyncRequest:!1}));r&&"function"==typeof r&&r()},s.initDone=!0,e.callback()}}},"BMd/":function(e,t,n){"use strict";n.d(t,"a",(function(){return L}));var i=n("lwsE"),r=n.n(i),o=n("W8MJ"),a=n.n(o),s=n("lSNA"),d=n.n(s),c=n("EVdn"),l=n.n(c),u=n("VEaK"),h=n("28oz"),v=n("K0eG"),f=n("jxKE"),g=n("wCkA"),p=n("95RW"),m=n("vDqi"),b=n.n(m),S=n("5K3P"),k=n("7bd3"),C=function(){function e(){r()(this,e),d()(this,"audioContext",null),d()(this,"mergedStream",void 0)}return a()(e,[{key:"getAudioContext",value:function(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext}},{key:"disposeAudioContext",value:function(){this.audioContext&&"running"===this.audioContext.state&&(this.audioContext.close(),this.audioContext=null)}},{key:"mergeAudio",value:function(e,t){var n=new MediaStream;n.addTrack(e);var i=new MediaStream;i.addTrack(t);var r=this.getAudioContext(),o=r.createMediaStreamSource(n),a=r.createMediaStreamSource(i),s=r.createMediaStreamDestination();return o.connect(s),a.connect(s),this.mergedStream=s.stream,this.mergedStream}},{key:"dispose",value:function(){this.disposeAudioContext(),Object(g.Lb)(this.mergedStream)}}]),e}();d()(C,"shared",new C);var y=k.g.getOrCreateProfile("START_CLASS_SUCCESS_PROFILE"),w=k.g.getOrCreateProfile("CLICK_TO_VIEW_PROFILE"),T=k.g.getOrCreateProfile("PUBLISHER_CONNECT_PROFILE"),E=k.g.getOrCreateProfile("JANUS_CONNECTION_PROFILE"),D=k.g.getOrCreateProfile("ICE_STATE_TRANSITION"),I=k.g.getOrCreateProfile("HISTORY_DOWNLOAD"),A=k.g.getOrCreateProfile("HISTORY_COMMIT"),R=k.g.getOrCreateProfile("PUBLISHER_TIMELINE"),O=function(e,t){return e+t},N=k.g.getNewBatchAgg((function(e,t){var n,i;if(0===e)i=100;else{var r=Math.min(1,e/30),o=Math.E;i=Math.round(100*(1-1/(1+Math.exp(1.7*(1-o*r)))))}k.g.sendData(k.c.CLASS_QUALITY_DETERIORATION_INDEX,"Cardinality=".concat(t.card,";Nacks=").concat(t.nacks,";Value=").concat(e),(n={},d()(n,k.e.Card,1),d()(n,k.e.Measure1,i),n)),N.resetRelayData(),t.shouldStopRecursiveCall||t.host.logSlowLinkForEvent(0,0,t.shouldStopRecursiveCall)}));N.POST_INTERVAL=6e4;var L=function(){function e(){var t=this;r()(this,e),d()(this,"token",""),d()(this,"proxyToken",""),d()(this,"state",""),d()(this,"isCanvasModeEnabled",!1),d()(this,"role",""),d()(this,"roomId",""),d()(this,"mainFeed",null),d()(this,"supportingFeed",null),d()(this,"areMultiplePublishers",!1),d()(this,"supportingPublisher",!1),d()(this,"numberOfPublishers",1),d()(this,"id_counter",0),d()(this,"serverUrl",""),d()(this,"shouldReconnect",!0),d()(this,"classEnded",!1),d()(this,"reconnecting",!1),d()(this,"user_uid",""),d()(this,"classUid",""),d()(this,"name",""),d()(this,"reconnectTries",0),d()(this,"sendSupportingPublisherAudio",!0),d()(this,"sendSupportingPublisherVideo",!0),d()(this,"cameraDeviceId",null),d()(this,"microphoneDeviceId",null),d()(this,"connectionId",0),d()(this,"sessionId",0),d()(this,"useKube",!1),d()(this,"kube_domain",""),d()(this,"turn_servers",void 0),d()(this,"backup_turn_server",""),d()(this,"cameraEnabled",!0),d()(this,"micEnabled",!0),d()(this,"isClassPaused",!1),d()(this,"publisherVideoEnabled",!0),d()(this,"audioBitRate",0),d()(this,"analyticsData",void 0),d()(this,"trying_order_fix",!1),d()(this,"useGreenScreen",!1),d()(this,"useRoundVideo",!1),d()(this,"isCanvasStreaming",!1),d()(this,"screenSharingAllowed",!1),d()(this,"bitrate",0),d()(this,"server",""),d()(this,"isHlsClass",!1),d()(this,"isLiveDVR",!1),d()(this,"frameRate",0),d()(this,"isEducator",!1),d()(this,"isRaiseHandClass",!1),d()(this,"isCameraAndAudioEnabled",!0),d()(this,"isLocal","true"===Object(g.mb)("local")),d()(this,"janus",void 0),d()(this,"pluginHandle",void 0),d()(this,"remoteFeed",void 0),d()(this,"remoteFeedId",void 0),d()(this,"someOneElseConnected",!1),d()(this,"connected",!1),d()(this,"latestDataEventTime",0),d()(this,"updateOldDataStarted",!1),d()(this,"updatingOldData",!1),d()(this,"isPollingForPublisher",!1),d()(this,"remoteVideoAttached",!1),d()(this,"newEventsBeforeCompletingOldData",[]),d()(this,"opaqueId","screen-"+h.a.randomString(12)),d()(this,"isRaiseHandAudioAttached",!1),d()(this,"dataListeners",[]),d()(this,"connectionsListener",[]),d()(this,"restoreChangeListener",[]),d()(this,"multipleTabListener",[]),d()(this,"resetListeners",[]),d()(this,"slowLinkListeners",[]),d()(this,"localStreamListeners",[]),d()(this,"remoteStreamListeners",[]),d()(this,"videoPlayListener",void 0),d()(this,"onHistoryUpdatedListener",void 0),d()(this,"onLearnerConnectListeners",[]),d()(this,"onLearnerDisconnectListeners",[]),d()(this,"onEducatorConnectListeners",[]),d()(this,"onEducatorDisconnectListeners",[]),d()(this,"checkForPublisherInterval",void 0),d()(this,"getFrameRateInterval",void 0),d()(this,"keepAliveThread",void 0),d()(this,"iceStateDisconnectedTimer",void 0),d()(this,"dataCheckInterval",void 0),d()(this,"stream",void 0),d()(this,"localMediaStream",void 0),d()(this,"screenSharingStream",void 0),d()(this,"mergedLearnerEducatorStream",void 0),d()(this,"raiseHandAudioStream",null),d()(this,"updateStartTime",0),d()(this,"resolutionToUse",null),d()(this,"janusHistoryFetchToken",null),d()(this,"setUseRoundVideo",(function(e){t.useRoundVideo=e})),d()(this,"startMultiplePublisherSession",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.supportingPublisher,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.supportingFeed,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];console.log("MultiplePublisher",e,n),t.areMultiplePublishers=!0,t.supportingPublisher=e,t.supportingFeed=n,e&&(t.micEnabled=i,t.publisherVideoEnabled=r,t.sendSupportingPublisherAudio=i,t.sendSupportingPublisherVideo=r),t.startSecondConnection()})),d()(this,"endMultiplePublisherSession",(function(){console.log("Reset MultiplePublisher"),t.endSecondConnection(),t.areMultiplePublishers=!1,t.supportingPublisher=!1,t.supportingFeed=null,t.isRaiseHandAudioAttached=!1})),d()(this,"startSecondConnection",(function(){t.areMultiplePublishers&&(t.supportingPublisher?t.reconnect("Raise hand",void 0,!0,!1):t.startAsListener())})),d()(this,"endSecondConnection",(function(){if("listener"==t.role){var e,n;null===(e=t.pluginHandle)||void 0===e||e.hangup(),null===(n=t.pluginHandle)||void 0===n||n.detach(),t.pluginHandle=null,t.localMediaStream&&Object(g.Lb)(t.localMediaStream),t.raiseHandAudioStream&&(Object(g.Lb)(t.raiseHandAudioStream),t.raiseHandAudioStream=null),t.reconnect("Raise Hand end",void 0,!0,!1)}else{var i,r;if(t.isRaiseHandClass){t.raiseHandAudioStream&&(Object(g.Lb)(t.raiseHandAudioStream),t.raiseHandAudioStream=null);var o=document.getElementById("audioElement");o&&(o.srcObject=null)}else t.stopSharingMergedVideo();null===(i=t.remoteFeed)||void 0===i||i.hangup(),null===(r=t.remoteFeed)||void 0===r||r.detach(),t.remoteFeed=null,t.checkForPublisherInterval&&clearInterval(t.checkForPublisherInterval)}})),d()(this,"getBitrate",(function(e){return e||(t.screenSharingAllowed?55e4:t.isCanvasModeEnabled?t.supportingPublisher?25e4:18e4:15e5)})),d()(this,"setCameraDeviceId",(function(e){t.cameraDeviceId=e})),d()(this,"setMicrophoneDeviceId",(function(e){t.microphoneDeviceId=e})),d()(this,"getCameraDeviceId",(function(){return t.cameraDeviceId})),d()(this,"getMicrophoneDeviceId",(function(){return t.microphoneDeviceId})),d()(this,"hashCode",(function(e){var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t})),d()(this,"reconnect",(function(e,n){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];Object(g.Hb)("Reconnect",t.analyticsData),!i&&!t.shouldReconnect||h.a.windowClosing||t.reconnecting||n&&t.sessionId!==n||(t.reconnectTries=t.reconnectTries+1,t.isEducator||k.g.sendData(k.c.RECONNECTION,e),(t.reconnectTries>5||t.updatingOldData)&&window.location&&r&&(t.logDisconnectReason("reconnect_exceeded"),k.g.sendData(k.c.RECONNECT_EXCEEDED,{sessionId:n,fqsource:"reconnect"}),S.b.dispatchEvent(S.a.RELOAD_IFRAME)),t.setState(f.lc.CONNECTING),t.disconectJanus(!1,"RECONNECT_EXCEEDED"),t.shouldReconnect=!0,t.resetVar(),setTimeout((function(){t.start()}),1e3),t.logDisconnectReason("reconnecting"))})),d()(this,"getIsCameraEnabled",(function(){return t.cameraEnabled})),d()(this,"setBitrate",(function(e){t.bitrate=e})),d()(this,"getFrameRate",(function(){t.getFrameRateInterval=setInterval((function(){t.remoteFeed&&t.remoteFeed.webrtcStuff&&t.remoteFeed.webrtcStuff.pc?t.remoteFeed.webrtcStuff.pc.getStats((function(e){e.result().filter((function(e){return"ssrc"===e.type})).forEach((function(e){var n=parseInt(e.stat("googFrameRateDecoded"));!1===isNaN(n)&&(t.frameRate=n)}))})):t.frameRate=0}),200)})),d()(this,"onFeedCleanup",(function(){console.log("Feed cleanup called"),t.remoteFeedId=void 0,t.remoteVideoAttached=!1,t.isRaiseHandAudioAttached=!1,t.onPublisherDisconnect(),t.onFeedDisconnect()})),d()(this,"startOffer",(function(){var e,n,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=!1,o=!1;t.shouldSendVideo()&&(r={deviceId:t.cameraDeviceId?{exact:t.cameraDeviceId}:void 0,width:{exact:null===(e=t.resolutionToUse)||void 0===e?void 0:e.width},height:{exact:null===(n=t.resolutionToUse)||void 0===n?void 0:n.height}});t.shouldSendAudio()&&(t.microphoneDeviceId?(o={}).mandatory={sourceId:t.microphoneDeviceId}:o=!0),navigator.mediaDevices.getUserMedia({audio:o,video:r}).then((function(e){var n;t.localMediaStream=e;var i=new MediaStream;if(t.shouldSendVideo())if("publisher"===t.role)if(t.useGreenScreen){var r=document.getElementById("mainVideo");if(r){Object(g.h)(r,e),r.muted=!0,r.play();var o=document.getElementById("streamingCanvas").captureStream(20).getVideoTracks()[0];o.enabled=t.publisherVideoEnabled,i.addTrack(o)}}else if(t.areMultiplePublishers&&!t.isRaiseHandClass){var a=document.getElementById("mainVideo");if(a){t.publisherVideoEnabled&&Object(g.h)(a,e),a.muted=!0,a.play();var s=document.getElementById("multiEducatorTempCanvas");if(s){var d=s.captureStream(20).getVideoTracks()[0];d.enabled=t.publisherVideoEnabled,i.addTrack(d)}}}else{var c=e.getVideoTracks()[0];c.enabled=t.publisherVideoEnabled,i.addTrack(c)}else if(t.areMultiplePublishers&&t.supportingPublisher)if(t.isRaiseHandClass);else{var l=document.getElementById("mainVideo");if(l&&(Object(g.h)(l,e),l.muted=!0,l.play()),t.publisherVideoEnabled){var u=e.getVideoTracks()[0];i.addTrack(u)}}if(t.shouldSendAudio()){var v=e.getAudioTracks()[0];v.enabled=t.micEnabled,i.addTrack(v)}null===(n=t.pluginHandle)||void 0===n||n.createOffer({media:{data:"publisher"==t.role,videoSend:t.shouldSendVideo(),audioSend:t.shouldSendAudio(),videoRecv:!1,audioRecv:!1},stream:i,success:function(e){var n;h.a.debug("Got publisher SDP!"),h.a.debug(e),e.sdp=e.sdp.replace("a=rtpmap:111 opus/48000/2","a=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 nack");var i={request:"configure",audio:t.shouldSendAudio(),video:t.shouldSendVideo(),data:"publisher"==t.role,record:!0,bitrate:t.bitrate,filename:t.classUid,token:t.token};console.log("onPublisherJoinsend"),null===(n=t.pluginHandle)||void 0===n||n.send({message:i,jsep:e,error:function(e){h.a.error("WebRTC error:",e),t.reconnect("WEBRTC_ERROR="+e.message),t.logException(e,"")}})},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){h.a.error("WebRTC error:",e),console.log("****",e),t.reconnect("WEBRTC_ERROR="+e.message),t.logException(e,"")}))})})).catch((function(e){i||(t.shouldSendVideo()?t.getBestFeedToSend(!0):t.startOffer(!0)),console.log("Get user media camera error",e)}))})),d()(this,"toggleCamera",(function(){t.cameraEnabled?t.disableCamera():t.enableCamera()})),d()(this,"disableCameraAndAudio",(function(){if(t.isCameraAndAudioEnabled&&"publisher"!=t.role&&t.isJanusConnected()&&t.remoteFeed){var e={request:"configure",video:!1,audio:!1,token:t.token};console.log("onSubscriberConfsend"),t.remoteFeed.send({message:e}),t.isCameraAndAudioEnabled=!1}})),d()(this,"enableCameraAndAudio",(function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!t.isCameraAndAudioEnabled&&(t.stream&&(e&&h.a.attachMediaStream(l()("#screenvideo").get(0),t.stream),t.playVideo()),"publisher"!=t.role&&t.isJanusConnected()&&t.remoteFeed)){var n={request:"configure",video:!0,audio:!0,token:t.token};console.log("onSubscriberConfsend"),t.remoteFeed.send({message:n}),t.isCameraAndAudioEnabled=!0}})),d()(this,"getPublisherPausedVideoStream",(function(){var e=document.getElementById("classPauseCanvas");return e?new MediaStream(e.captureStream(60)):null}))}return a()(e,[{key:"setUp",value:function(e,t,n,i,r){var o;(this.token=e.token,this.proxyToken=e.proxyToken,this.isCanvasModeEnabled=1!==e.authorType,this.role=e.role,this.roomId=e.room,this.mainFeed=e.mainFeed,this.supportingFeed=e.supportingFeed,this.numberOfPublishers=e.numberOfPublishers,this.areMultiplePublishers=e.isMultiEduClass,this.isRaiseHandClass=e.isRaiseHandClass,this.supportingPublisher=e.isModerator,this.id_counter=0,this.serverUrl=e.server,this.user_uid=e.uid,this.classUid=e.classId,this.name=e.name,this.cameraDeviceId=n,this.microphoneDeviceId=i,this.useKube=e.useKube,this.kube_domain=e.kubeDomain,this.turn_servers=e.iceServers,this.backup_turn_server=this.serverUrl,this.audioBitRate=this.isCanvasModeEnabled?64:128,this.analyticsData=t,this.trying_order_fix=!1,this.useGreenScreen=e.useChroma,this.isCanvasStreaming=e.streamCanvas,this.screenSharingAllowed=e.screenSharingAllowed,this.bitrate=this.getBitrate(null===(o=e.classConfig)||void 0===o?void 0:o.janusConfigBitrate),this.server=this.getServer(this.serverUrl),this.isHlsClass=!!e.hlsUrl,this.isEducator="publisher"===this.role.toLowerCase(),this.setState(f.lc.INIT),this.setUseRoundVideo(r),this.resetVar(),this.isEducator)||(k.g.sendData(k.c.METRIC_CALC_START,{isRecorded:!1,isWeb:!0}),this.resetUnknownEventState(y,"startClassSuccessProfile","profile is running before start up while it should not"),y.start(),y.ttl(k.a.Live).then((function(){k.g.sendData(k.c.CLASS_START_FAILURE,{ttlExpired:!0,refreshed:!0})})),this.logSlowLinkForEvent(0,0,!1))}},{key:"setState",value:function(e){this.state=e,this.sendConnectionState(),k.g.sendData(k.c.JANUS_DATA,{state:e,fqsource:"setState"})}},{key:"setGreenScreen",value:function(e){this.useGreenScreen=e}},{key:"getServer",value:function(e){return"wss://"+e+"/janus"}},{key:"getHttpServer",value:function(e){return"https://"+e+":"+v.a.HTTPS_PORT+"/janus"}},{key:"resetVar",value:function(){this.janus=void 0,this.pluginHandle=void 0,this.remoteFeed=void 0,this.remoteFeedId=void 0,this.id_counter=0,this.someOneElseConnected=!1,this.trying_order_fix=!1,this.connected=!1,this.newEventsBeforeCompletingOldData=[],this.updatingOldData=!1,this.updateOldDataStarted=!1,this.opaqueId="screen-"+h.a.randomString(12),this.checkForPublisherInterval=void 0,this.remoteVideoAttached=!1,this.isRaiseHandAudioAttached=!1,this.cancelJanusHistoryFetch()}},{key:"cancelJanusHistoryFetch",value:function(){this.janusHistoryFetchToken&&this.janusHistoryFetchToken.cancel()}},{key:"startAsListener",value:function(){var e=this;if("publisher"!==this.role||this.areMultiplePublishers){"listener"==this.role&&this.setState(f.lc.CONNECTING);var t=this.mainFeed;"publisher"==this.role&&this.areMultiplePublishers&&(t=this.supportingFeed),this.checkForPublisherInterval&&clearInterval(this.checkForPublisherInterval),k.g.sendData(k.c.WAITING_FOR_PUBLISHER,"PublisherId=".concat(t)),this.resetUnknownEventState(T,"publisherConnectProfile","profile is running before start up while it should not"),T.start(),this.checkForPublisherConnect(t),y.pause(),w.pause(),this.checkForPublisherInterval=setInterval((function(){e.checkForPublisherConnect(t)}),3e3)}}},{key:"startStream",value:function(e){var t,n={request:"watch",id:e,token:this.token,private_id:Math.floor(1e4*Math.random())};k.g.sendData(k.c.STREAM_START,{id:n.id,request:"watch",fqsource:"startStream"}),null===(t=this.remoteFeed)||void 0===t||t.send({message:n})}},{key:"switchStream",value:function(e){var t,n={request:"switch",id:parseInt(e),token:this.token};k.g.sendData(k.c.STREAM_SWITCH,{id:n.id,request:"switch",fqsource:"switchStream"}),null===(t=this.remoteFeed)||void 0===t||t.send({message:n})}},{key:"stopStream",value:function(){var e,t={request:"stop",token:this.token};k.g.sendData(k.c.STREAM_STOP,{request:"stop",fqsource:"stopStream"}),null===(e=this.remoteFeed)||void 0===e||e.send({message:t})}},{key:"getClientHost",value:function(e){var t,n=this;if(this.useKube)e(this.kube_domain);else{var i={request:"client_hosts",room_id:this.roomId,token:this.token};null===(t=this.pluginHandle)||void 0===t||t.send({message:i,success:function(t){var i=n.serverUrl;if(!t.error){var r=t.hosts,o=r.length;if(o>0){var a=r[Math.abs(n.hashCode(n.user_uid))%o];a.ip&&(i=a.ip,console.log("Using stream server:"+i))}}n.backup_turn_server=i,e(i)}})}}},{key:"start",value:function(){var e=this;this.setState(f.lc.CONNECTING),this.sessionId=this.sessionId+1;var t=this.sessionId;this.resetUnknownEventState(E,"publisherConnectProfile","profile is running before start up while it should not"),E.start(),this.connect((function(){e.reconnecting=!1,e.reconnectTries=0,k.g.sendData(k.c.JANUS_CONNECTION_SUCCESSFUL,{sessionId:e.sessionId,fqsource:"start.connect[success]"}),console.log("connected..."),console.log("this.sessionId"+e.sessionId+"currentSession"+t)}),(function(){if(e.sessionId===t){e.setState(f.lc.CONNECTING),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{sessionId:e.sessionId,fqsource:"start.connect[failure]"}),console.log("this.sessionId"+e.sessionId+"currentSession"+t),console.log("connect failed..."),e.reconnecting=!1;var n=Math.min(10,e.reconnectTries);setTimeout((function(){k.g.sendData(k.c.JANUS_CONNECTION_RETRY,{currentSession:t,fqsource:"start.connect[failure]"}),e.reconnect("CONNECTION_FAILURE",t)}),1e3*n)}}))}},{key:"disconectJanus",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e&&(this.classEnded=!0),this.shouldReconnect=!1,this.keepAliveThread&&clearInterval(this.keepAliveThread),this.checkForPublisherInterval&&clearInterval(this.checkForPublisherInterval),this.getFrameRateInterval&&clearInterval(this.getFrameRateInterval),this.iceStateDisconnectedTimer&&clearTimeout(this.iceStateDisconnectedTimer),this.latestDataEventTime=0,this.removeDataCheckLoop(),this.remoteFeed&&this.remoteFeed.webrtcStuff&&this.remoteFeed.webrtcStuff.dataChannel&&(this.remoteFeed.webrtcStuff.dataChannel.onmessage=void 0);try{h.a.destroyAllSessions(),this.stream&&(this.stream.getVideoTracks()[0].stop(),this.stream.getAudioTracks()[0].stop()),this.localMediaStream&&!this.areMultiplePublishers&&Object(g.Lb)(this.localMediaStream);var n=document.getElementById("screenvideo");n&&(n.src=""),k.g.sendData(k.c.JANUS_DISCONNECTION_SUCCESSFUL,{fqsource:"disconectJanus"})}catch(i){k.g.sendData(k.c.JANUS_DISCONNECTION_ERROR,{msg:i.message,fqsource:"disconectJanus"}),console.error(i)}finally{this.isEducator||k.g.sendData(k.c.JANUS_DISCONNECTED,"ClassEnded=".concat(e,";Reason=").concat(t))}}},{key:"startAsPublisher",value:function(){this.joinAsPublisher()}},{key:"startKeepAliveThread",value:function(){var e=this;this.keepAliveThread&&clearInterval(this.keepAliveThread);var t=15e3;"publisher"==this.role&&(t=6e3),this.keepAliveThread=setInterval((function(){e.keepAlive()}),t)}},{key:"reconnectIfNopublisher",value:function(e){var t=this;this.isPublisherConnected(e,(function(){}),(function(){t.reconnect("RECONNECT_NO_PUBLISHER")}))}},{key:"onPublisherSuccess",value:function(){var e=this;this.supportingPublisher||(this.startDataCheckLoop(),this.updatingOldData=!0,this.onRestoreStateChange(!0),setTimeout((function(){e.updateOldData()}),1e3))}},{key:"addRestoreChangeListener",value:function(e){this.restoreChangeListener.push(e)}},{key:"onRestoreStateChange",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=0;n<this.restoreChangeListener.length;n++)this.restoreChangeListener[n](e,t)}},{key:"updateOldData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25e3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this.updateOldDataStarted||this.updateOldDataUtil(e,t,n,i,r),this.updateOldDataStarted=!0,this.isEducator}},{key:"updateOldDataUtil",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25e3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(r>2)return k.g.sendData(k.c.HISTORY_FAILURE,{role:this.role}),void this.afterUpdateOldData([]);I.isProfileRunning()||I.start();var a=b.a.CancelToken.source();this.janusHistoryFetchToken=a;var s=p.a.getURLs(),c=s.PROXY_URL,l="".concat(c,"/v1/api/history/");b.a.get(l,{params:{token:this.proxyToken,offset:n,limit:i},cancelToken:a.token}).then((function(a){var s=a.data.plugindata.data;if(s){var c;if(t=t.concat(s.list),!e.updatingOldData)return void(e.updateOldDataStarted=!1);s.has_more&&o?e.updateOldDataUtil(t,n=t.length,i,0,o):(e.updateStartTime=(new Date).getTime(),e.onRestoreStateChange(!0),A.start(),e.updateData(t,0,2e3),I.end());var u=I.timeSinceLastCall().dts;k.g.sendData(k.c.HISTORY_DOWNLOAD_TIME,"Ur".concat(l,";Offset=").concat(n,";Limit=").concat(i,";Retry=").concat(r),(c={},d()(c,k.e.Card,1),d()(c,k.e.Measure1,u),c))}})).catch((function(a){console.log("error",a),k.g.sendData(k.c.HISTORY_FAILURE,{msg:a.message}),e.updateOldDataUtil(t,n,i,r+1,o)}))}},{key:"updateData",value:function(e,t,n){var i=this;if(this.updatingOldData){for(var r=t+n;t<e.length&&t<r;t++){var o=e[t],a=void 0;try{a=JSON.parse(o.data)}catch(s){e.splice(t,1)}if(a)try{this.onData(a,!0)}catch(s){}}t<e.length?window.requestAnimationFrame((function(){i.updateData(e,t,n)})):this.afterUpdateOldData(e)}else this.updateOldDataStarted=!1}},{key:"afterUpdateOldData",value:function(e){var t;if(this.updatingOldData){var n=0;0!=e.length&&(n=JSON.parse(e[e.length-1].data)[f.X.CURRENT_TIME]),console.log("this.newEventsBeforeCompletingOldData:",this.newEventsBeforeCompletingOldData.length),console.log("this.lastEventTime:"+n);for(var i=0;i<this.newEventsBeforeCompletingOldData.length;i++){var r=this.newEventsBeforeCompletingOldData[i];r[f.X.CURRENT_TIME]>n&&this.onData(r,!0)}this.newEventsBeforeCompletingOldData=[],this.updatingOldData=!1,this.updateOldDataStarted=!1,this.onRestoreStateChange(!1),this.onHistoryUpdatedListener&&this.onHistoryUpdatedListener(),k.g.sendData(k.c.HISTORY_UPDATE_TIME,null,(t={},d()(t,k.e.Card,1),d()(t,k.e.Measure1,A.end().dts),t))}else this.updateOldDataStarted=!1}},{key:"getIceServers",value:function(){if(this.turn_servers)return this.turn_servers;var e=[{urls:v.a.TURN.url(this.backup_turn_server,"tcp"),username:v.a.TURN.USERNAME,credential:v.a.TURN.PASSWORD}];return Object(g.rb)()||e.push({urls:v.a.TURN.url(this.backup_turn_server,"udp"),username:v.a.TURN.USERNAME,credential:v.a.TURN.PASSWORD}),e}},{key:"getHostNewRequestPluginHandler",value:function(e,t){var n=this,i=this.getHttpServer(this.serverUrl),r=new h.a({server:i,token:this.token,iceServers:this.getIceServers(),success:function(){null===r||void 0===r||r.attach({plugin:"janus.plugin.videoroom",opaqueId:n.opaqueId,success:function(t){e&&e(t,r),k.g.sendData(k.c.JANUS_CONNECTION_SUCCESSFUL,{plugin:"janus.plugin.videoroom",fqname:"getHostNewRequestPluginHandler[success]"})},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){t&&t(e),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{fqname:"getHostNewRequestPluginHandler[failure]",plugin:"janus.plugin.videoroom",msg:e.message})}))})}},!1)}},{key:"connect",value:function(e,t){var n=this;this.onReset(),this.setState(f.lc.CONNECTING),h.a.init({debug:!1,callback:function(){"publisher"==n.role?n.startPublisherJanus(e,t):(E.bookmark("LibInited",u.d.TIME_SINCE_LAST_CALL),n.startAsListener())}})}},{key:"attachPublisherPlugin",value:function(e,t){var n,i=this,r=this.sessionId;null===(n=this.janus)||void 0===n||n.attach({plugin:"janus.plugin.videoroom",opaqueId:this.opaqueId,success:function(e){var t,n;if(i.sessionId==r){console.log("attached plugin"),i.pluginHandle=e;var o=null===(t=i.pluginHandle)||void 0===t?void 0:t.getId();h.a.log("Plugin attached! ("+(null===(n=i.pluginHandle)||void 0===n?void 0:n.getPlugin())+", id="+o+")"),i.startAsPublisher(),i.startKeepAliveThread(),i.sendConnectionState(),k.g.sendData(k.c.JANUS_CONNECTION_SUCCESSFUL,{fqname:"startEducatorJanus.success",id:o})}},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){i.sessionId==r&&(t&&t(e),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{msg:e.message,fqname:"startEducatorJanus.error",fullErr:JSON.stringify(e)}))})),webrtcState:function(e,t){i.sessionId==r&&(e?(console.log("on"),i.sendConnectionState(),k.g.sendData(k.c.WEBRTC_STATE,{sessionId:r,isOn:e,fqname:"startEducatorJanus.webrtcState"})):(console.log("destroy",t),i.sendConnectionState(),i.connected=!1,clearInterval(i.keepAliveThread),i.setState(f.lc.DISCONNECTED),i.logDisconnectReason("webrtc_closed"),i.reconnect("WEBRTC_DESTORY_REASON="+t,r),k.g.sendData(k.c.WEBRTC_STATE,{sessionId:r,isOn:e,fqname:"startEducatorJanus.webrtcState"})))},onmessage:function(e,t){if(i.sessionId==r){if(console.log("msg publisher"+JSON.stringify(e)),e&&"kicked"==e.reason)return i.shouldReconnect=!1,i.setState(f.lc.KICKED),i.someOneElseConnected=!0,i.onMultipleTabConnect(),i.disconectJanus(!1,"KICKED"),void k.g.sendData(k.c.USER_KICKED);436!=e.error_code?"publisher"!=i.role||426!=e.error_code?i.handleMessage(e,t):i.createNewRoom((function(){i.joinAsPublisher()})):i.handleReconnect(e,t)}},onlocalstream:function(n){var o,a,s;i.sessionId==r&&(i.micEnabled||i.disableMic(),"listener"!=i.role?(h.a.debug(" ::: Got a local stream :::"),h.a.debug(n),i.stream=n,i.isClassPaused&&i.pauseVideoAndAudio(!0,!0,!0),i.onLocalStream(n),i.screenSharingStream&&i.startScreenSharing(i.screenSharingStream),i.areMultiplePublishers&&!i.isRaiseHandClass||(h.a.attachMediaStream(l()("#screenvideo").get(0),n),l()("#screenvideo").prop("muted",!0),i.playVideo()),"failed"!==(null===(o=i.pluginHandle)||void 0===o?void 0:o.webrtcStuff.pc.iceConnectionState)&&"disconnected"!==(null===(a=i.pluginHandle)||void 0===a?void 0:a.webrtcStuff.pc.iceConnectionState)&&"closed"!==(null===(s=i.pluginHandle)||void 0===s?void 0:s.webrtcStuff.pc.iceConnectionState)||t(),e&&e()):i.isRaiseHandClass&&(i.raiseHandAudioStream=n))},iceState:function(e){i.sessionId==r&&(console.log("iceState:"+e),i.iceStateDisconnectedTimer&&clearTimeout(i.iceStateDisconnectedTimer),"connected"===e&&i.onPublisherPluginConnect(),"failed"!==e&&"closed"!==e||(i.setState(f.lc.DISCONNECTED),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{fqsource:"startEducatorJanus.iceState",state:e}),i.reconnect("ICESTATE_"+e.toUpperCase(),r),i.logDisconnectReason("ice_state_"+e)),"disconnected"==e&&i.state==f.lc.CONNECTED&&(i.iceStateDisconnectedTimer=setTimeout((function(){i.state==f.lc.CONNECTED&&(k.g.sendData(k.c.JANUS_CONNECTION_CLOSE,{role:i.role,fqsource:"startEducatorJanus.iceState",state:"ICE_STATE_DISCONNECTED"}),i.reconnect("ICE_STATE_DISCONNECTED",r))}),6e3)))},onremotestream:function(e){},ondataopen:function(){i.onPublisherSuccess()},onDataChannelStateChange:function(e){if(i.sessionId==r){if(null==e)return i.connected=!1,void i.sendConnectionState();switch(e){case"connecting":break;case"open":i.setState(f.lc.CONNECTED),i.connected=!0;break;case"closing":i.state==f.lc.CONNECTED&&(i.setState(f.lc.DISCONNECTED),i.logDisconnectReason("data_channel_closing")),i.connected=!1;break;case"closed":i.state==f.lc.CONNECTED&&(i.setState(f.lc.DISCONNECTED),i.logDisconnectReason("data_channel_closed"),k.g.sendData(k.c.JANUS_DISCONNECTED,{fqsource:"startEducatorJanus.onDataChannelStateChange",state:"DATA_CHANNEL_DISCONNECTED"})),i.connected=!1}i.sendConnectionState()}},oncleanup:function(){}})}},{key:"startPublisherJanus",value:function(e,t){var n=this,i=this.sessionId,r=this.server;this.janus=new h.a({server:r,token:this.token,iceServers:this.getIceServers(),success:function(){n.attachPublisherPlugin(e,t),n.areMultiplePublishers&&n.startAsListener()},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){n.sessionId==i&&(clearInterval(n.keepAliveThread),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{msg:e.message,from:"startEducatorJanus.error",fullErr:JSON.stringify(e)}),t&&t())})),destroyed:function(){clearInterval(n.keepAliveThread),n.sessionId==i&&n.setState(f.lc.DISCONNECTED)}},!0)}},{key:"handleReconnect",value:function(e,t){var n,i="publisher"==this.role?this.mainFeed:this.supportingFeed,r={request:"kick",room:this.roomId,id:i,token:this.token};null===(n=this.pluginHandle)||void 0===n||n.send({message:r}),this.joinAsPublisher()}},{key:"checkForPublisherConnect",value:function(e){var t=this;this.isPublisherConnected(e,(function(){var n;y.resume(),w.resume(),"publisher"==t.role&&t.areMultiplePublishers?t.onFeed(t.supportingFeed,"",(function(){console.log("Second educator feed")})):(t.onReset(),t.startLearnerJanus());var i=T.end();k.g.sendData(k.c.PUBLISHER_CONNECTED,"PublisherId=".concat(e,";areMultiplePublishers=").concat(t.areMultiplePublishers),(n={},d()(n,k.e.Card,1),d()(n,k.e.Measure1,i.dts),n)),t.checkForPublisherInterval&&(clearInterval(t.checkForPublisherInterval),t.checkForPublisherInterval=void 0)}))}},{key:"isPublisherConnected",value:function(e,t,n){var i=this;if(!this.isPollingForPublisher){this.isPollingForPublisher=!0;var r=p.a.getURLs().PROXY_URL;b.a.get("".concat(r,"/v1/api/educator_status/"),{params:{token:this.proxyToken}}).then((function(n){if(i.isPollingForPublisher=!1,n.data&&n.data.plugindata&&n.data.plugindata.data){var r=n.data.plugindata.data.participants;if(i.remoteFeedId&&i.isConnected())return;if(r){for(var o=0;o<r.length;o++)if(r[o].id==e)return void(t&&t());"publisher"!==i.role&&i.setState(f.lc.WAITING_FOR_EDUCATOR)}}})).catch((function(e){i.isPollingForPublisher=!1,i.setState(f.lc.WAITING_FOR_EDUCATOR),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{error:e.message,state:"EDUCATOR_STATUS_FAIL",fqsource:"isPublisherConnected"})})),n&&n()}}},{key:"handleMessage",value:function(e,t){switch(e.videoroom){case"joined":this.onJoin(e);break;case"event":this.onEvent(e)}void 0!==t&&null!==t&&(h.a.debug("Handling SDP as well..."),h.a.debug(t),t.sdp=t.sdp.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+this.audioBitRate+"\r\n"),t.sdp=t.sdp.replace("a=rtpmap:111 opus/48000/2","a=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 nack"),this.pluginHandle&&this.pluginHandle.handleRemoteJsep({jsep:t}))}},{key:"printProperty",value:function(e){for(var t in e)t+": "+e[t]+"; "}},{key:"startDataCheckLoop",value:function(){var e=this;this.removeDataCheckLoop(),this.dataCheckInterval=setInterval((function(){if("listener"==e.role){var t=(new Date).getTime();e.latestDataEventTime&&t-e.latestDataEventTime>12e3&&(e.latestDataEventTime=t,k.g.sendData(k.c.NO_DATA_IN_LAST_12_SEC))}else if("publisher"==e.role){var n=(new Date).getTime();if(e.latestDataEventTime&&n-e.latestDataEventTime>5e3){var i=Object(g.y)();e.sendData(i)}}}),5e3)}},{key:"removeDataCheckLoop",value:function(){this.dataCheckInterval&&clearInterval(this.dataCheckInterval)}},{key:"onEvent",value:function(e){if("listener"===this.role&&void 0!==e.publishers&&null!==e.publishers);else if(void 0!==e.leaving&&null!==e.leaving){var t=e.leaving;h.a.log("Publisher left: "+t),k.g.sendData(k.c.JANUS_DATA,{fqsource:"onEvent",msg:"Publisher left: "+t}),"listener"===this.role&&e.leaving===this.remoteFeedId&&(this.onFeedDisconnect(),this.setState(f.lc.CONNECTING),this.reconnect("LEAVING"));"publisher"==this.role?this.mainFeed:this.supportingFeed;"publisher"==this.role&&t==this.mainFeed&&this.reconnectIfNopublisher(this.mainFeed),"listener"==this.role&&this.supportingPublisher&&t==this.supportingFeed&&this.reconnectIfNopublisher(this.supportingFeed)}else void 0!==e.error&&null!==e.error&&k.g.sendData(k.c.JANUS_DATA,{fqsource:"onEvent",msg:"Error received"})}},{key:"startLearnerJanus",value:function(){var e=this;this.sessionId=this.sessionId+1,this.setState(f.lc.CONNECTING);var t=this.sessionId,n=this.useKube?this.kube_domain:this.serverUrl;this.areMultiplePublishers&&this.supportingPublisher&&(n=this.serverUrl),E.bookmark("Waiting",u.d.TIME_SINCE_LAST_CALL),this.connectStream(n,(function(){e.reconnecting=!1,e.reconnectTries=0,console.log("connected..."),console.log("this.sessionId"+e.sessionId+"currentSession"+t);var n=E.end();k.g.sendData(k.c.JANUS_CONNECTED,"SessionId=".concat(e.sessionId,";").concat(E.getStrDataFromContext()),d()({},k.e.Measure1,n.dts))}),(function(){if(e.sessionId===t){var n=E.end();k.g.sendData(k.c.JANUS_DISCONNECTED,"SessionId=".concat(e.sessionId,";janusConnectionProfile.getStrDataFromContext()"),d()({},k.e.Measure1,n.dts)),console.log("this.sessionId"+e.sessionId+"currentSession"+t),console.log("connect failed..."),e.reconnecting=!1;var i=Math.min(10,e.reconnectTries);setTimeout((function(){e.reconnect("CONNECT_STREAM_FAILED",t)}),1e3*i)}}))}},{key:"connectStream",value:function(e,t,n){var i=this,r=this.sessionId;this.janus=new h.a({server:this.getServer(e),token:this.token,iceServers:this.getIceServers(),success:function(){i.startKeepAliveThread(),i.onFeed(i.mainFeed,"",(function(){i.startDataCheckLoop(),i.updatingOldData=!0,i.onRestoreStateChange(!0,!0),setTimeout((function(){i.updateOldData()}),1e3)})),i.supportingPublisher&&i.attachPublisherPlugin(t,n),t()},error:function(){i.sessionId==r&&n&&n()},destroyed:function(){i.sessionId==r&&i.setState(f.lc.DISCONNECTED)}})}},{key:"getJanusPlugin",value:function(){return this.isLocal||this.areMultiplePublishers&&(this.supportingPublisher||"publisher"==this.role)?"janus.plugin.videoroom":"janus.plugin.streaming"}},{key:"onFeed",value:function(e,t,n){var i,r=this,o=this.sessionId;this.remoteFeedId=e;var a=this.getJanusPlugin();this.janus&&(D.start(),null===(i=this.janus)||void 0===i||i.attach({plugin:a,opaqueId:this.opaqueId,success:function(t){if(r.remoteFeed=t,"janus.plugin.streaming"==a)r.startStream(12);else if("janus.plugin.videoroom"==a){var n,i;k.g.sendData(k.c.JANUS_CONNECTION_SUCCESSFUL,{fqsource:"onFeed"}),h.a.log("Plugin attached! ("+(null===(n=r.remoteFeed)||void 0===n?void 0:n.getPlugin())+", id="+(null===(i=r.remoteFeed)||void 0===i?void 0:i.getId())+")"),h.a.log("  -- This is a subscriber");var o,s={request:"join",room:r.roomId,ptype:"listener",feed:e,token:r.token,video:!r.isHlsClass&&!r.isLiveDVR,audio:!r.isHlsClass&&!r.isLiveDVR,data:"listener"==r.role};if("safari"===h.a.webRTCAdapter.browserDetails.browser)s.offer_video=!1,s.offer_audio=!0,navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then((function(e){var t;null===(t=r.remoteFeed)||void 0===t||t.send({message:s})}));else null===(o=r.remoteFeed)||void 0===o||o.send({message:s})}k.g.sendData(k.c.JANUS_PLUGIN_ATTACH_SUCCESS,"Plugin=".concat(a),d()({},k.e.Measure1,D.timeSinceLastCall().dts))},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){k.g.sendData(k.c.JANUS_PLUGIN_ATTACH_FAILURE,{fqsource:"onFeed",msg:e.message}),h.a.error("  -- Error attaching plugin...",e),r.logException(e,""),r.reconnect("JANUS_PLUGIN_ATTACH_ERROR=".concat(e.message),o)})),slowLink:function(e,t){k.g.sendData(k.c.SLOW_LINK),console.log("Slow connection"),r.logSlowLink(e,t),r.onSlowLink()},onmessage:function(n,i){var o="janus.plugin.streaming"==a?n.streaming:n.videoroom;if(n&&"kicked"==n.reason)return r.shouldReconnect=!1,r.setState(f.lc.KICKED),r.someOneElseConnected=!0,r.onMultipleTabConnect(),void r.disconectJanus(!1,"KICKED");if(428!=n.error_code){if(h.a.debug("Event: "+o),void 0!=o&&null!=o&&"attached"===o){var s="Successfully attached to feed "+e+" ("+t+") in room "+n.room;k.g.sendData(k.c.JANUS_CONNECTION_SUCCESSFUL,{fqsource:"onFeed.onmessage",message:s}),h.a.log(s)}var d;if(void 0!==i&&null!==i)h.a.debug("Handling SDP as well..."),h.a.debug(i),i.sdp=i.sdp.replace("a=rtpmap:111 opus/48000/2","a=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 nack"),null===(d=r.remoteFeed)||void 0===d||d.createAnswer({jsep:i,media:{audioSend:!1,videoSend:!1,data:!0,audioRecv:!0,videoRecv:!0,replaceVideo:!0},success:function(e){var t;h.a.debug("Got SDP!"),h.a.debug(e),e.sdp=e.sdp.replace("a=rtpmap:111 opus/48000/2","a=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 nack");var n={request:"start",room:r.roomId,token:r.token};null===(t=r.remoteFeed)||void 0===t||t.send({message:n,jsep:e})},error:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){k.g.sendData(k.c.WEBRTC_ERROR,"Msg=".concat(e.message)),h.a.error("WebRTC error:",e),r.logException(e,"")}))})}else r.onFeedCleanup()},onlocalstream:function(e){},iceState:function(e){console.log("iceState:"+e),r.iceStateDisconnectedTimer&&clearTimeout(r.iceStateDisconnectedTimer),k.g.sendData(k.c.ICE_STATE_TRANSITION,"State=".concat(e),d()({},k.e.Measure1,D.timeSinceLastCall().dts)),"failed"!==e&&"closed"!==e||(r.logDisconnectReason("ice_state_"+e),r.reconnect("ICESTATE_".concat(e.toUpperCase()),o)),"disconnected"==e&&r.state==f.lc.CONNECTED&&(r.iceStateDisconnectedTimer=setTimeout((function(){r.state==f.lc.CONNECTED&&r.reconnect("ICESTATE_"+e.toUpperCase(),o)}),6e3)),"connected"===e&&r.onFeedConnect()},onDataChannelStateChange:function(e){if("listener"==r.role){if(null==e)return r.connected=!1,r.sendConnectionState(),r.setState(f.lc.CONNECTING),void r.reconnect("UNKNOWN_DATA_CHANNEL_STATE_CHANGE",o);switch(k.g.sendData(k.c.JANUS_DATA_CHANNEL_STATE_CHANGE,"state=".concat(e),d()({},k.e.Measure1,D.timeSinceLastCall().dts)),e){case"connecting":break;case"open":r.connected=!0,r.setState(f.lc.CONNECTED);break;case"closing":r.state==f.lc.CONNECTED&&(r.setState(f.lc.DISCONNECTED),r.logDisconnectReason("data_channel_closing")),r.connected=!1;break;case"closed":r.state==f.lc.CONNECTED&&(r.setState(f.lc.DISCONNECTED),k.g.sendData(k.c.JANUS_CONNECTION_FAILURE,{fqname:"onFeed.onDataChannelStateChange",state:e}),r.logDisconnectReason("data_channel_closed")),r.connected=!1}r.sendConnectionState()}},webrtcState:function(e,t){e?(console.log("on"),r.sendConnectionState(),k.g.sendData(k.c.PEER_CONNECTION_ESTABLISHED,"Reason=".concat(t))):(k.g.sendData(k.c.WEBRTC_ERROR,"Reason=".concat(t)),console.log("destroy",t),r.sendConnectionState(),r.connected=!1,clearInterval(r.keepAliveThread),r.onFeedDisconnect())},ondataopen:function(e){"listener"==r.role&&r.remoteFeed&&(r.remoteFeed.webrtcStuff.dataChannel.onmessage=function(e){r.latestDataEventTime=(new Date).getTime(),r.onData(JSON.parse(e.data))},k.g.sendData(k.c.JANUS_DATA_CHANNEL_READY_TO_USE,"Feed=".concat(r.remoteFeed),d()({},k.e.Measure1,D.timeSinceLastCall().dts))),n&&n()},onremotestream:function(e){if(!r.isHlsClass&&!r.isLiveDVR)if("publisher"!==r.role&&(r.stream=e),r.onRemoteStream(e),"listener"===r.role)r.remoteVideoAttached||(r.remoteVideoAttached=!0,h.a.attachMediaStream(l()("#screenvideo").get(0),e),r.playVideo());else if(r.isRaiseHandClass){if(!r.isRaiseHandAudioAttached){r.raiseHandAudioStream=e;var t=document.getElementById("audioElement");t&&(r.isRaiseHandAudioAttached=!0,Object(g.f)(t,e),t.play())}}else r.remoteVideoAttached||(r.remoteVideoAttached=!0,h.a.attachMediaStream(l()("#screenvideo").get(0),e),r.playVideo());k.g.sendData(k.c.PEER_CONNECTION_OK,"Stream=".concat(e))},oncleanup:function(){h.a.log(" ::: Got a cleanup notification (remote feed "+e+") :::"),r.onFeedCleanup()}}))}},{key:"onPublisherDisconnect",value:function(){var e=this;setTimeout((function(){e.startAsListener()}),2e3)}},{key:"onJoin",value:function(e){k.g.sendData(k.c.PUB_JOIN,{fqname:"onJoin",role:this.role,supportingPublisher:this.supportingPublisher}),R.start(),("publisher"==this.role||"listener"==this.role&&this.supportingPublisher)&&this.onPublisherJoin(e)}},{key:"onPublisherJoin",value:function(e){h.a.debug("Negotiating WebRTC stream for our screen (capture  "),this.shouldSendVideo()?this.getBestFeedToSend():this.startOffer(!1)}},{key:"getBestFeedToSend",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];Object(g.r)(this.isCanvasModeEnabled,this.cameraDeviceId,this.useRoundVideo||this.areMultiplePublishers,t).then((function(n){e.resolutionToUse=n,e.startOffer(t)}))}},{key:"startSharingMergedVideo",value:function(){var e=this;"publisher"==this.role&&this.areMultiplePublishers&&Object(g.r)(this.isCanvasModeEnabled,this.cameraDeviceId,this.useRoundVideo||this.areMultiplePublishers,null).then((function(t){var n,i={};n={deviceId:e.cameraDeviceId?{exact:e.cameraDeviceId}:void 0,width:{exact:null===t||void 0===t?void 0:t.width},height:{exact:null===t||void 0===t?void 0:t.height}},e.microphoneDeviceId&&(i.mandatory={sourceId:e.microphoneDeviceId}),navigator.mediaDevices.getUserMedia({audio:i,video:n}).then((function(t){e.localMediaStream&&Object(g.Lb)(e.localMediaStream),e.localMediaStream=t;var n=document.getElementById("mainVideo");if(n){if(e.publisherVideoEnabled)Object(g.h)(n,t);else{var i=new MediaStream,r=document.getElementById("videoOffCanvas");i.addTrack(r.captureStream(20).getVideoTracks()[0]),Object(g.h)(n,i)}n.muted=!0,n.play()}var o=document.getElementById("multiEducatorTempCanvas"),a=e.pluginHandle?e.pluginHandle.webrtcStuff:null;if(e.mergedLearnerEducatorStream=o.captureStream(20),a)for(var s in a.pc.getSenders()){var d=a.pc.getSenders()[s];if(d&&d.track&&"video"===d.track.kind){var c,l=null===(c=e.mergedLearnerEducatorStream)||void 0===c?void 0:c.getVideoTracks()[0];d.replaceTrack(l)}if(d&&d.track&&"audio"===d.track.kind){var u,h=null===(u=e.localMediaStream)||void 0===u?void 0:u.getAudioTracks()[0];h.enabled=e.micEnabled,d.replaceTrack(h)}}}))}))}},{key:"stopSharingMergedVideo",value:function(){var e=this;Object(g.r)(this.isCanvasModeEnabled,this.cameraDeviceId,!1,null).then((function(t){var n,i={};n={deviceId:e.cameraDeviceId?{exact:e.cameraDeviceId}:void 0,width:{exact:null===t||void 0===t?void 0:t.width},height:{exact:null===t||void 0===t?void 0:t.height}},e.microphoneDeviceId&&(i.mandatory={sourceId:e.microphoneDeviceId}),navigator.mediaDevices.getUserMedia({audio:i,video:n}).then((function(t){e.localMediaStream&&Object(g.Lb)(e.localMediaStream),e.localMediaStream=t,e.mergedLearnerEducatorStream=void 0;var n=document.getElementById("mainVideo");n&&(Object(g.h)(n,t),n.muted=!0,n.play());var i=e.pluginHandle?e.pluginHandle.webrtcStuff:null;if(i)for(var r in i.pc.getSenders()){var o=i.pc.getSenders()[r];if(o&&o.track&&"video"===o.track.kind)if(e.publisherVideoEnabled){var a,s=null===(a=e.localMediaStream)||void 0===a?void 0:a.getVideoTracks()[0];o.replaceTrack(s)}else{var d=document.getElementById("videoOffCanvas");o.replaceTrack(d.captureStream(20).getVideoTracks()[0])}if(o&&o.track&&"audio"===o.track.kind){var c,l=null===(c=e.localMediaStream)||void 0===c?void 0:c.getAudioTracks()[0];l.enabled=e.micEnabled,o.replaceTrack(l)}}}))}))}},{key:"startScreenSharing",value:function(e){this.screenSharingStream||(this.screenSharingStream=e);var t=this.pluginHandle?this.pluginHandle.webrtcStuff:null;if(t)for(var n in t.pc.getSenders()){var i,r=t.pc.getSenders()[n];if(r&&r.track&&"video"===r.track.kind)r.replaceTrack(null===(i=this.screenSharingStream)||void 0===i?void 0:i.getVideoTracks()[0]);if(r&&r.track&&"audio"===r.track.kind){var o,a,s=null!==(o=null===(a=this.screenSharingStream)||void 0===a?void 0:a.getAudioTracks())&&void 0!==o?o:[];if(s.length>0){var d=C.shared.mergeAudio(s[0],r.track);r.replaceTrack(d.getAudioTracks()[0])}}}}},{key:"stopScreenSharing",value:function(){var e,t;this.screenSharingStream=void 0,C.shared.dispose();var n=null===(e=this.localMediaStream)||void 0===e?void 0:e.getVideoTracks()[0],i=null===(t=this.localMediaStream)||void 0===t?void 0:t.getAudioTracks()[0];if(this.mergedLearnerEducatorStream)n=this.mergedLearnerEducatorStream.getVideoTracks()[0];else if(!this.publisherVideoEnabled){n=document.getElementById("videoOffCanvas").captureStream(20).getVideoTracks()[0]}if(i&&n){var r=this.pluginHandle?this.pluginHandle.webrtcStuff:null;if(!r)return;for(var o in r.pc.getSenders()){var a=r.pc.getSenders()[o];a&&a.track&&"video"===a.track.kind&&a.replaceTrack(n),a&&a.track&&"audio"===a.track.kind&&(i.enabled=this.micEnabled,a.replaceTrack(i))}}else this.reconnect("NO_LOCAL_STREAM",this.sessionId)}},{key:"shouldSendAudio",value:function(){return"listener"!==this.role||!this.areMultiplePublishers||!this.supportingPublisher||this.sendSupportingPublisherAudio}},{key:"shouldSendVideo",value:function(){return"listener"!==this.role||!this.areMultiplePublishers||!this.supportingPublisher||this.sendSupportingPublisherVideo}},{key:"onListenerJoin",value:function(e){if(void 0!==e.publishers&&null!==e.publishers){var t=e.publishers;for(var n in h.a.debug("Got a list of available publishers/feeds:"),h.a.debug(t),t){var i=t[n].id,r=t[n].display;h.a.debug("  >> ["+i+"] "+r),this.onFeed(i,r)}}}},{key:"isConnected",value:function(){return this.state==f.lc.CONNECTED}},{key:"isCurrentRoomExists",value:function(){}},{key:"addConnectionListener",value:function(e){this.connectionsListener.push(e)}},{key:"sendConnectionState",value:function(){for(var e=0;e<this.connectionsListener.length;e++)this.connectionsListener[e](this.state)}},{key:"removeConnectionListener",value:function(e){var t=this.connectionsListener.indexOf(e);-1!==t&&this.connectionsListener.splice(t,1)}},{key:"canSendData",value:function(){return"publisher"==this.role&&this.state==f.lc.CONNECTED}},{key:"setRoomId",value:function(e){}},{key:"updateRoomId",value:function(e){}},{key:"updateAllOldData",value:function(e){}},{key:"createNewRoom",value:function(e){var t,n=this,i={request:"create",description:"rom disc",room:this.roomId,rec_dir:"/opt/rec/",bitrate:0,fir_freq:1,publishers:this.numberOfPublishers,permanent:!0,no_of_publishers:this.numberOfPublishers,main_feed_id:this.mainFeed};null===(t=this.pluginHandle)||void 0===t||t.send({message:i,success:function(t){var i=t.videoroom;h.a.debug("Event: "+i),void 0!=i&&null!=i&&(n.roomId=t.room,e())}})}},{key:"joinAsPublisher",value:function(){var e;h.a.log(this.supportingFeed);var t={request:"join",room:this.roomId,ptype:"publisher",display:this.name,id:this.supportingPublisher?this.supportingFeed:this.mainFeed,token:this.token};k.g.sendData(k.c.PUB_JOIN,{fqname:"joinAsPublisher",role:this.role,room:this.roomId}),null===(e=this.pluginHandle)||void 0===e||e.send({message:t})}},{key:"keepAlive",value:function(){var e=!0;if(this.remoteFeed&&this.remoteFeed.session&&this.useKube){var t={janus:"keepalive",session_id:this.remoteFeed.session.getSessionId(),transaction:h.a.randomString(12),token:this.token};this.remoteFeed.send({message:t}),e=!1}if(this.pluginHandle&&this.pluginHandle.session){var n={janus:"keepalive",session_id:this.pluginHandle.session.getSessionId(),transaction:h.a.randomString(12),token:this.token};this.pluginHandle.send({message:n}),e=!1}e&&this.keepAliveThread&&clearInterval(this.keepAliveThread)}},{key:"isJanusConnected",value:function(){return this.janus&&this.janus.isConnected&&this.janus.isConnected()}},{key:"disableCamera",value:function(){if(this.cameraEnabled=!1,"publisher"==this.role&&this.isJanusConnected()&&this.pluginHandle){var e={request:"configure",video:!1,audio:!0,token:this.token};console.log("onPublisherConfsend"),this.pluginHandle.send({message:e})}else if("publisher"!=this.role&&this.isJanusConnected()&&this.remoteFeed){e={request:"configure",video:!1,audio:!0,token:this.token};console.log("onSubscriberConfsend"),this.remoteFeed.send({message:e})}}},{key:"enableDVR",value:function(){this.isLiveDVR=!0}},{key:"disableDVR",value:function(){this.isLiveDVR=!1}},{key:"pauseVideoAndAudio",value:function(e,t,n){var i=this.pluginHandle?this.pluginHandle.webrtcStuff:null;if(this.isClassPaused=e,i&&i.pc&&i.pc.getSenders)for(var r in i.pc.getSenders()){var o=i.pc.getSenders()[r];if(o&&o.track&&"video"===o.track.kind)if(t){var a=this.getPublisherPausedVideoStream();if(a)try{o.replaceTrack(a.getVideoTracks()[0])}catch(s){console.log("Track replace error"),o.track.enabled=!1}else o.track.enabled=!1}else this.stream&&(o.track.enabled=!0,o.replaceTrack(this.stream.getVideoTracks()[0]));o&&o.track&&"audio"===o.track.kind&&(o.track.enabled=!n)}}},{key:"playVideo",value:function(){this.videoPlayListener&&this.videoPlayListener()}},{key:"enableCamera",value:function(){if(this.cameraEnabled=!0,this.stream&&this.playVideo(),"publisher"==this.role&&this.isJanusConnected()&&this.pluginHandle){var e={request:"configure",video:!0,audio:!0,token:this.token};console.log("onPublisherConfsend"),this.pluginHandle.send({message:e})}else if("publisher"!=this.role&&this.isJanusConnected()&&this.remoteFeed){e={request:"configure",video:!0,audio:!0,token:this.token};console.log("onSubscriberConfsend"),this.remoteFeed.send({message:e})}}},{key:"handlePublisherVideo",value:function(e){var t=this.pluginHandle?this.pluginHandle.webrtcStuff:null;if(t&&t.pc&&t.pc.getSenders)for(var n in t.pc.getSenders()){var i=t.pc.getSenders()[n];if(i&&i.track&&"video"===i.track.kind)if("publisher"==this.role&&this.areMultiplePublishers){var r=document.getElementById("mainVideo");if(r){var o=new MediaStream;if(e){var a;o.addTrack(null===(a=this.localMediaStream)||void 0===a?void 0:a.getVideoTracks()[0])}else{var s=document.getElementById("videoOffCanvas");o.addTrack(s.captureStream(20).getVideoTracks()[0])}Object(g.h)(r,o)}}else if(e){var d;i.replaceTrack(null===(d=this.localMediaStream)||void 0===d?void 0:d.getVideoTracks()[0])}else{var c=document.getElementById("videoOffCanvas");i.replaceTrack(c.captureStream(20).getVideoTracks()[0])}}this.publisherVideoEnabled=e}},{key:"enablePublisherCamera",value:function(){("publisher"===this.role||this.areMultiplePublishers&&this.supportingPublisher)&&this.handlePublisherVideo(!0)}},{key:"disablePublisherCamera",value:function(){("publisher"===this.role||this.areMultiplePublishers&&this.supportingPublisher)&&this.handlePublisherVideo(!1)}},{key:"handleMicAudio",value:function(e){var t=this.pluginHandle?this.pluginHandle.webrtcStuff:null;if(t&&t.pc&&t.pc.getSenders){for(var n in t.pc.getSenders()){var i=t.pc.getSenders()[n];i&&i.track&&"audio"===i.track.kind&&(i.track.enabled=e&&!this.isClassPaused)}this.micEnabled=e}}},{key:"disableMic",value:function(){("publisher"===this.role||this.areMultiplePublishers&&this.supportingPublisher)&&this.handleMicAudio(!1)}},{key:"enableMic",value:function(){("publisher"===this.role||this.areMultiplePublishers&&this.supportingPublisher)&&this.handleMicAudio(!0)}},{key:"joinScreen",value:function(){var e,t={request:"join",room:this.roomId,ptype:"publisher",display:this.name,token:this.token};null===(e=this.pluginHandle)||void 0===e||e.send({message:t})}},{key:"onData",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(n||!this.updatingOldData){if(e.id&&this.id_counter+1!=e.id&&(!n||this.trying_order_fix))return e.id<=this.id_counter?void console.error("same id"):this.trying_order_fix?(console.error("Not able to recover wrong string "+(this.id_counter+1)+" "+e.id),k.g.sendData(k.c.WRONG_ORDER,{fqname:"ondata",expected_id:this.id_counter+1,received_id:e.id}),void this.reconnect("WRONG_ORDER")):(console.error("GOT Wrong order string "+(this.id_counter+1)+" "+e.id),this.updatingOldData=!0,this.newEventsBeforeCompletingOldData.push(e),this.trying_order_fix=!0,void setTimeout((function(){t.updateOldData([],t.id_counter,1e4,0,!0)}),1e3));this.trying_order_fix=!1,e.id&&(this.id_counter=e.id);for(var i=0;i<this.dataListeners.length;i++)this.dataListeners[i](e,n)}else this.newEventsBeforeCompletingOldData.push(e)}},{key:"sendData",value:function(e){this.canSendData()&&this.pluginHandle&&(this.latestDataEventTime=(new Date).getTime(),this.pluginHandle.webrtcStuff.dataChannel.send(JSON.stringify(e)))}},{key:"onMultipleTabConnect",value:function(){this.multipleTabListener.forEach((function(e){e()}))}},{key:"onSlowLink",value:function(){this.slowLinkListeners.forEach((function(e){e()}))}},{key:"onReset",value:function(){this.id_counter=0,this.resetListeners.forEach((function(e){e()}))}},{key:"onLocalStream",value:function(e){this.localStreamListeners.forEach((function(t){t(e)}))}},{key:"onRemoteStream",value:function(e){this.remoteStreamListeners.forEach((function(t){t(e)}))}},{key:"addDataListener",value:function(e){this.dataListeners.push(e)}},{key:"addResetListener",value:function(e){this.resetListeners.push(e)}},{key:"addMultiTabListener",value:function(e){this.multipleTabListener.push(e)}},{key:"addSlowLinkListener",value:function(e){this.slowLinkListeners.push(e)}},{key:"removeDataListener",value:function(e){var t=this.dataListeners.indexOf(e);-1!==t&&this.dataListeners.splice(t,1)}},{key:"addVideoPlayListener",value:function(e){this.videoPlayListener=e}},{key:"addHistoryUpdatedListener",value:function(e){this.onHistoryUpdatedListener=e}},{key:"addLocalStreamListener",value:function(e){this.localStreamListeners.push(e)}},{key:"addRemoteStreamListener",value:function(e){this.remoteStreamListeners.push(e)}},{key:"addOnLearnerConnectListener",value:function(e){this.onLearnerConnectListeners.push(e)}},{key:"addOnLearnerDisconnectListener",value:function(e){this.onLearnerDisconnectListeners.push(e)}},{key:"addOnEducatorConnectListener",value:function(e){this.onEducatorConnectListeners.push(e)}},{key:"addOnEducatorDisconnectListener",value:function(e){this.onEducatorDisconnectListeners.push(e)}},{key:"removeOnLearnerConnectListener",value:function(e){this.onLearnerConnectListeners=this.onLearnerConnectListeners.filter((function(t){return t!==e}))}},{key:"removeOnLearnerDisconnectListener",value:function(e){this.onLearnerDisconnectListeners=this.onLearnerDisconnectListeners.filter((function(t){return t!==e}))}},{key:"removeOnEducatorConnectListener",value:function(e){this.onEducatorConnectListeners=this.onEducatorConnectListeners.filter((function(t){return t!==e}))}},{key:"removeOnEducatorDisconnectListener",value:function(e){this.onEducatorDisconnectListeners=this.onEducatorDisconnectListeners.filter((function(t){return t!==e}))}},{key:"triggerOnLearnerConnectListeners",value:function(){this.onLearnerConnectListeners.forEach((function(e){return e()}))}},{key:"triggerOnLearnerDisconnectListeners",value:function(){this.onLearnerDisconnectListeners.forEach((function(e){return e()}))}},{key:"triggerOnEducatorConnectListeners",value:function(){this.onEducatorConnectListeners.forEach((function(e){return e()}))}},{key:"triggerOnEducatorDisconnectListeners",value:function(){this.onEducatorDisconnectListeners.forEach((function(e){return e()}))}},{key:"onFeedConnect",value:function(){"publisher"===this.role&&this.triggerOnEducatorConnectListeners()}},{key:"onFeedDisconnect",value:function(){"listener"===this.role?this.triggerOnEducatorDisconnectListeners():this.triggerOnLearnerDisconnectListeners()}},{key:"onPublisherPluginConnect",value:function(){"listener"===this.role&&this.triggerOnLearnerConnectListeners()}},{key:"removeLocalStreamListener",value:function(e){var t=this.localStreamListeners.indexOf(e);-1!==t&&this.localStreamListeners.splice(t,1)}},{key:"removeRemoteStreamListener",value:function(e){var t=this.remoteStreamListeners.indexOf(e);-1!==t&&this.remoteStreamListeners.splice(t,1)}},{key:"removeAllListeners",value:function(){this.dataListeners=[],this.connectionsListener=[],this.restoreChangeListener=[],this.multipleTabListener=[],this.resetListeners=[],this.slowLinkListeners=[],this.localStreamListeners=[],this.remoteStreamListeners=[],this.onHistoryUpdatedListener=void 0,this.videoPlayListener=void 0,this.onLearnerConnectListeners=[],this.onEducatorConnectListeners=[],this.onLearnerDisconnectListeners=[],this.onEducatorDisconnectListeners=[]}},{key:"resetUnknownEventState",value:function(e,t,n){e.isProfileRunning()&&(e.end(),k.g.sendData(k.c.UNKNOWN_STATE,{fqsource:t,reason:n}))}},{key:"logSlowLinkForEvent",value:function(e,t,n){var i;N.push(e,O),(i=N.getRelayData())?N.setRelayData({shouldStopRecursiveCall:n,nacks:i.nacks+e,card:i.card+t,host:this}):N.setRelayData({nacks:e,card:1,shouldStopRecursiveCall:n,host:this})}},{key:"logSlowLink",value:function(e,t){var n=t/12|0;n>0&&this.logSlowLinkForEvent(n,1,!1)}},{key:"logDisconnectReason",value:function(e){this.classEnded||"publisher"!=this.role||k.g.sendData(k.c.WEBRTC_STATE,{disconnected:!0,role:this.role,reason:e,fqname:"logDisconnectReason"})}},{key:"logException",value:function(e,t){}},{key:"dispose",value:function(){this.logSlowLinkForEvent(0,0,!0)}}]),e}();d()(L,"shared",new L)}}]);
//# sourceMappingURL=utils~chat~live.cb8307e66b4461f1b431.chunk.js.map